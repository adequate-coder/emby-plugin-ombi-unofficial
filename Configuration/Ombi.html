<!DOCTYPE html>
<html>

<head>
    <title>Ombi</title>
</head>

<body>
    <div data-role="page" class="page type-interior pluginConfigurationPage ombiConfigurationPage"
        data-require="emby-button">

        <div data-role="content">
            <div class="content-primary">

                <form class="ombiConfigurationPage">
                    <ul class="ulForm" data-role="listview">
                        <li>
                            <label for="ombiHost">Host (name or IP)</label>
                            <input type="text" id="ombiHost" name="ombiHost" required>
                            <div class="fieldDescription">
                                E.g. <code>localhost</code>, <code>your.ombi.xyz</code> or <code>172.16.12.34</code>
                            </div>
                        </li>

                        <li>
                            <label for="ombiPort">Port</label>
                            <input type="text" id="ombiPort" name="ombiPort" required>
                            <div class="fieldDescription">
                                E.g. <code>3579</code>
                            </div>
                        </li>

                        <li>
                            <label for="ombiBase">URL base</label>
                            <input type="text" id="ombiBase" name="ombiBase">
                            <div class="fieldDescription">
                                For reverse proxy support, default is empty, .e.g. <code>/ombi</code>.
                            </div>
                        </li>

                        <li>
                            <label for="ombiHttps">Use HTTPS</label>
                            <input type="checkbox" id="ombiHttps" name="ombiHttps">
                            <div class="fieldDescription">
                                Enable HTTPS if your Ombi instance is protected by TLS. Typically only desirable when
                                Emby and Ombi are on different machines.
                            </div>
                        </li>


                        <li>
                            <button id="ombiValidate" type="button" data-mini="true">Validate</button>
                        </li>

                        <li>
                            <label for="ombiKey">API key</label>
                            <input type="text" id="ombiKey" name="ombiKey" required>
                            <div class="fieldDescription">
                                Copy the API key from your Ombi instance's general configuration.
                            </div>
                        </li>

                        <li>
                            <label for="ombiUser">Ombi user (optional)</label>
                            <input type="text" id="ombiUser" name="ombiUser">
                            <div class="fieldDescription">
                                Choose an Ombi user to impersonate when syncing content to Ombi, or leave empty to use
                                an anonymous admin user.
                            </div>
                        </li>

                        <li>
                            <label for="ombiRecentOnly">Use fast sync</label>
                            <input type="checkbox" id="ombiRecentOnly" name="ombiRecentOnly">
                            <div class="fieldDescription">
                                When enabled, only recently added items are synced to Ombi. This speeds up request
                                processing, but it requires that you
                                configure Emby Server: settings >
                                Library > Advanced > "Date added behavior for new content" > "Use date scanned into the
                                library"
                            </div>
                        </li>

                        <li>
                            <button type="submit" data-theme="b" data-mini="true">Save</button>
                            <button type="button" onclick="history.back();" data-mini="true">Cancel</button>
                        </li>
                    </ul>
                </form>
            </div>
        </div>

        <script type="text/javascript">

            (function () {

                var pluginId = "b68a226e-5a88-4ff8-9a72-e443646ea121";

                $('.ombiConfigurationPage').off('pageshow').on('pageshow', function (event) {

                    Dashboard.showLoadingMsg();

                    ApiClient.getPluginConfiguration(pluginId).then(function (config) {
                        $('#ombiHost').val(config.Host);
                        $('#ombiPort').val(config.Port);
                        $('#ombiBase').val(config.UrlBase);
                        $('#ombiHttps').prop('checked', config.UseHttps);
                        $('#ombiKey').val(config.ApiKey);
                        $('#ombiUser').val(config.User);
                        $('#ombiRecentOnly').prop('checked', config.RecentOnly);

                        Dashboard.hideLoadingMsg();
                    });
                });

                $('#ombiValidate').off('click').on('click', function (e) {
                    var configuration = {
                        Host: $('#ombiHost').val(),
                        Port: $('#ombiPort').val(),
                        UrlBase: $('#ombiBase').val(),
                        UseHttps: $('#ombiHttps').prop('checked'),
                        ApiKey: $('#ombiKey').val(),
                        User: $('#ombiUser').val(),
                        RecentOnly: $('#ombiRecentOnly').prop('checked')
                    };

                    var params = new URLSearchParams(configuration).toString();

                    ApiClient.getJSON('/Ombi/Version?' + params)
                        .then(
                            function (data) {
                                console.dir(data)
                                Dashboard.alert({
                                    title: 'Ok',
                                    message: 'Successfully connect to "' + configuration.Host + '", Ombi version ' + data.Version + '.'
                                });
                            },
                            function (data) {
                                data.text().then(text => {
                                    Dashboard.alert({
                                        title: 'Error',
                                        message: text
                                    });
                                })
                            }
                        );
                });

                $('.ombiConfigurationPage').off('submit.plugin').on('submit.plugin', function (e) {

                    Dashboard.showLoadingMsg();

                    ApiClient.getPluginConfiguration(pluginId).then(function (config) {
                        config.Host = $('#ombiHost').val();
                        config.Port = $('#ombiPort').val();
                        config.UrlBase = $('#ombiBase').val();
                        config.UseHttps = $('#ombiHttps').prop('checked');
                        config.ApiKey = $('#ombiKey').val();
                        config.User = $('#ombiUser').val();
                        config.RecentOnly = $('#ombiRecentOnly').prop('checked');

                        ApiClient.updatePluginConfiguration(pluginId, config).then(Dashboard.processPluginConfigurationUpdateResult);
                    });

                    return false;
                });

            })();

        </script>
    </div>
</body>

</html>