define(["exports","./../modules/tabbedview/basetab.js","./../modules/loading/loading.js","./../modules/common/globalize.js","./../modules/common/responsehelper.js","./../modules/emby-apiclient/connectionmanager.js","./../modules/emby-elements/emby-input/emby-input.js","./../modules/emby-elements/emby-button/emby-button.js","./../modules/emby-elements/emby-checkbox/emby-checkbox.js","./../modules/emby-elements/emby-select/emby-select.js","./../modules/emby-elements/emby-premierecontainer/emby-premierecontainer.js","./../modules/listview/listview.js","./../modules/layoutmanager.js","./codeccontroller.js"],function(_exports,_basetab,_loading,_globalize,_responsehelper,_connectionmanager,_embyInput,_embyButton,_embyCheckbox,_embySelect,_embyPremierecontainer,_listview,_layoutmanager,_codeccontroller){function loadPage(instance,config,codecs,defaultCodecConfigurations){var view=instance.view,selectHwa=view.querySelector(".selectHwa"),defaultCodecConfigurations=(selectHwa.value=config.HardwareAccelerationMode||0,1===config.HardwareAccelerationMode?defaultCodecConfigurations:config.CodecConfigurations||[]);instance.codecList||(instance.codecList=codecs,function(instance,context,codecs,codecConfigs){if(null==codecs||0===codecs.length)return;(function(codecs,codecConfigs){for(var i=0,length=codecs.length;i<length;i++){var codec=codecs[i],config=function(codecConfigs,codecId){if(codecId&&null!=codecConfigs&&0!==codecConfigs.length)for(var i=0;i<codecConfigs.length;i++)if(codecConfigs[i]&&codecConfigs[i].CodecId&&codecConfigs[i].CodecId===codecId)return codecConfigs[i];return null}(codecConfigs,codec.Id);codec.Priority=(null==config?void 0:config.Priority)||0,codec.IsEnabled=(null==config?void 0:config.IsEnabled)||!1}})(codecs,codecConfigs),context.querySelector(".hardwareDecoders").innerHTML=renderCodecsGrouped(0,0,codecs.filter(function(codec){return"Decoder"===codec.Direction&&codec.IsHardwareCodec})),context.querySelector(".hardwareEncoders").innerHTML=renderCodecsGrouped(0,0,codecs.filter(function(codec){return"Encoder"===codec.Direction&&codec.IsHardwareCodec}));for(var itemContainers=context.querySelectorAll(".itemsContainerCodecGroup"),i=0,length=itemContainers.length;i<length;i++){var itemContainer=itemContainers[i];itemContainer.fetchData=getCodecGroupItems.bind({instance:instance,Direction:itemContainer.getAttribute("data-direction"),Group:itemContainer.getAttribute("data-group"),IsHardwareCodec:"true"===itemContainer.getAttribute("data-ishardwarecodec")}),itemContainer.getListOptions=getCodecGroupListOptions.bind(instance)}}(instance,view,codecs,defaultCodecConfigurations)),view.querySelector(".chkEnableThrottle").checked=config.EnableThrottling,view.querySelector(".txtDownMixAudioBoost").value=config.DownMixAudioBoost,view.querySelector(".txtTranscodingTempPath").value=config.TranscodingTempPath||"",view.querySelector(".chkEnableSubtitleExtraction").checked=config.EnableSubtitleExtraction||!1,onHwaModeChange.call(instance,{target:selectHwa,currentTarget:selectHwa}),_loading.default.hide()}function getCodecItems(instance,filterFn){var items=instance.codecList.filter(filterFn);items.sort(function(c1,c2){return c2.Priority-c1.Priority});for(var serverId=instance.getApiClient().serverId(),filterFn=(items=items.map(function(i){var name=i.Name;return i.IsHardwareCodec||(name=i.MediaTypeName),{OriginalItem:i,Type:"Codec",Id:i.Id,IsFolder:!1,ServerId:serverId,Name:name,CanReorder:i.IsHardwareCodec}})).length,i=0,length=items.length;i<length;i++){var item=items[i];item.CanMoveUp=0<i,item.CanMoveDown=i<items.length-1}return Promise.resolve({Items:items,TotalRecordCount:filterFn})}function getCodecGroupItems(query){var options=this;return getCodecItems(options.instance,function(codec){return codec.MediaTypeName===options.Group&&codec.Direction===options.Direction&&codec.IsHardwareCodec===options.IsHardwareCodec})}function getCodecGroupListOptions(items){items=1<items.length;return{renderer:_listview.default,options:{defaultBackground:!1,moreButton:!1,action:_layoutmanager.default.tv?"menu":"none",multiSelect:!1,image:!1,buttonCommands:["codecinfo","edit"],dragReorder:items,draggable:items,draggableXActions:!1,fields:["ItemCheckbox","Name"],checkboxAction:onItemsChecked,getIsItemChecked:getIsItemChecked,commandActions:{moveInOrder:function(items,options){var firstCodec=items[0].OriginalItem,allItems=this.codecList.filter(function(c){return c.IsHardwareCodec===firstCodec.IsHardwareCodec&&c.MediaTypeName===firstCodec.MediaTypeName&&c.Direction===firstCodec.Direction});return allItems.sort(function(c1,c2){return c2.Priority-c1.Priority}),function(movedItems,allItems,options){console.log("onItemsMovedToNewIndex");movedItems=allItems.indexOf(movedItems[0].OriginalItem),options=options.newIndex;if(console.log("onItemsMovedToNewIndex, fromIndex: "+movedItems+", newIndex: "+options),movedItems!==options){!function(arr,fromIndex,toIndex){var element=arr[fromIndex];arr.splice(fromIndex,1),arr.splice(toIndex,0,element)}(allItems,movedItems,options);for(var i=0,length=allItems.length;i<length;i++)allItems[i].Priority=100-i}return Promise.resolve()}(items,allItems,options)}.bind(this)}}}}function getIsItemChecked(item){return item.OriginalItem.IsEnabled}function onItemsChecked(options){for(var items=options.items,checked=options.checked,i=0,length=items.length;i<length;i++)items[i].OriginalItem.IsEnabled=checked;return Promise.resolve()}function renderCodecsGrouped(context,codecConfigs,codecs){return codecs.map(function(item){return item.MediaTypeName}).filter(distinct).map(function(group){var groupCodecs=codecs.filter(function(codec){return codec.MediaTypeName===group});return function(group,codecs){var html="",direction=(html='<div style="margin-bottom:1.8em;"><h3 style="margin:0;" class="secondaryText">'+group+"</h3>",codecs[0].Direction),codecs=codecs[0].IsHardwareCodec;return html=html+'<div is="emby-itemscontainer" data-ishardwarecodec="'+codecs+'" data-direction="'+direction+'" data-group="'+group+'" class="codecList itemsContainer itemsContainerCodecGroup vertical-list"></div></div>'}(group,groupCodecs)}).join("")}function distinct(value,index,self){return self.indexOf(value)===index}function onHwaModeChange(e){for(var e=e.currentTarget,advancedSections=this.view.querySelectorAll(".hwaAdvanced"),mode=e.value,i=0,length=advancedSections.length;i<length;i++)"2"===mode?advancedSections[i].classList.remove("hide"):advancedSections[i].classList.add("hide")}function checkMediaEncodingInitialization(instance,apiClient){return _loading.default.show(),apiClient.getToneMapOptions().then(function(toneMapOptions){var view=instance.view;return view.querySelector(".encodingSettingsForm").classList.remove("hide"),view.querySelector(".encodingNotInitializedMessage").classList.add("hide"),function(instance,apiClient){_loading.default.show();var configPromise=apiClient.getNamedConfiguration("encoding"),codecInfoPromise=apiClient.getVideoCodecInformation().catch(function(){return[]}),apiClient=apiClient.getJSON(apiClient.getUrl("Encoding/CodecConfiguration/Defaults")).catch(function(){return[]});return Promise.all([configPromise,codecInfoPromise,apiClient]).then(function(responses){loadPage(instance,responses[0],responses[1],responses[2])})}(instance,apiClient)},function(errorResponse){var view=instance.view;if(view.querySelector(".encodingSettingsForm").classList.add("hide"),view.querySelector(".encodingNotInitializedMessage").classList.remove("hide"),503===errorResponse.status)return function(instance,apiClient){return new Promise(function(resolve,reject){setTimeout(function(){checkMediaEncodingInitialization(instance,apiClient).then(resolve,reject)},1e3)})}(instance,apiClient);_loading.default.hide()})}function TranscodingTab(view,params){_basetab.default.apply(this,arguments)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,Object.assign(TranscodingTab.prototype,_basetab.default.prototype),TranscodingTab.prototype.loadTemplate=function(){return require(["text!transcoding/transcodingtab.html"])},TranscodingTab.prototype.onTemplateLoaded=function(){_basetab.default.prototype.onTemplateLoaded.apply(this,arguments);var apiClient=_connectionmanager.default.currentApiClient(),view=this.view,apiClient=(view.querySelector(".selectHwa").addEventListener("change",onHwaModeChange.bind(this)),view.querySelector(".hwaGuideLink").innerHTML=_globalize.default.translate("SeeOurHwaGuide",'<a is="emby-linkbutton" href="https://support.emby.media/support/solutions/articles/44001160148-hardware-acceleration-overview" class="button-link" target="_blank">',"</a>"),view.querySelector(".btnSelectTranscodingTempPath").addEventListener("click",function(){Emby.importModule("./modules/directorybrowser/directorybrowser.js").then(function(directoryBrowser){var picker=new directoryBrowser;picker.show({callback:function(path){path&&(view.querySelector(".txtTranscodingTempPath").value=path),picker.close()},validateWriteable:!0,header:_globalize.default.translate("HeaderSelectTranscodingPath"),instruction:_globalize.default.translate("HeaderSelectTranscodingPathHelp")})})}),view.querySelector(".encodingSettingsForm").addEventListener("submit",function(e){var instance=this,form=e.target,apiClient=(_loading.default.show(),instance.getApiClient());return apiClient.getNamedConfiguration("encoding").then(function(config){config.DownMixAudioBoost=form.querySelector(".txtDownMixAudioBoost").value,config.TranscodingTempPath=form.querySelector(".txtTranscodingTempPath").value,config.EnableSubtitleExtraction=form.querySelector(".chkEnableSubtitleExtraction").checked,config.EnableThrottling=form.querySelector(".chkEnableThrottle").checked;var selectHwa=form.querySelector(".selectHwa"),codecConfigs=(config.HardwareAccelerationMode=parseInt(selectHwa.value),[]);if(2===config.HardwareAccelerationMode)for(var codecList=instance.codecList,i=0,length=codecList.length;i<length;i++){var codec=codecList[i];codec.IsHardwareCodec&&(codec={CodecId:codec.Id,Priority:codec.Priority,IsEnabled:codec.IsEnabled},codecConfigs.push(codec))}config.HardwareAccelerationType=null,config.CodecConfigurations=codecConfigs,apiClient.updateNamedConfiguration("encoding",config).then(function(response){_loading.default.hide(),_responsehelper.default.handleConfigurationSavedResponse(response)})}),e.preventDefault(),e.stopPropagation(),!1}.bind(this)),apiClient.getSystemInfo().then(function(systemInfo){for(var hwaPremiereInfo=view.querySelectorAll(".hwaPremiereInfo"),i=0,length=hwaPremiereInfo.length;i<length;i++)systemInfo.HardwareAccelerationRequiresPremiere?hwaPremiereInfo[i].classList.remove("hide"):hwaPremiereInfo[i].classList.add("hide"),hwaPremiereInfo[i].innerHTML=_globalize.default.translate("FeatureRequiresEmbyPremiere",'<a href="https://emby.media/premiere" data-preset="premiereinfo" is="emby-linkbutton" type="button" class="button-link btnHwaPremiere">',"</a>")}),view.querySelector(".softwareEncoders"));apiClient.fetchData=function(query){return getCodecItems(this,function(codec){return"Encoder"===codec.Direction&&!codec.IsHardwareCodec&&codec.SupportsParameters})}.bind(this),apiClient.getListOptions=function(items){return{renderer:_listview.default,options:{defaultBackground:!1,moreButton:!1,action:_layoutmanager.default.tv?"edit":"none",multiSelect:!1,image:!1,draggable:!1,draggableXActions:!1,buttonCommands:["edit"],fields:["Name"]}}}.bind(this)},TranscodingTab.prototype.onResume=function(options){_basetab.default.prototype.onResume.apply(this,arguments);var instance=this;return checkMediaEncodingInitialization(this,this.getApiClient()).then(function(){for(var itemContainers=instance.view.querySelectorAll(".itemsContainer"),promises=[],i=0,length=itemContainers.length;i<length;i++)promises.push(itemContainers[i].waitForCustomElementUpgrade());return Promise.all(promises).then(function(){for(var _i=0,_length=itemContainers.length;_i<_length;_i++)itemContainers[_i].resume(options)})})},TranscodingTab.prototype.onPause=function(){_basetab.default.prototype.onPause.apply(this,arguments);for(var itemContainers=this.view.querySelectorAll(".itemsContainer"),i=0,length=itemContainers.length;i<length;i++)itemContainers[i].pause()},TranscodingTab.prototype.destroy=function(){_basetab.default.prototype.destroy.apply(this,arguments),this.codecList=null};_exports.default=TranscodingTab});