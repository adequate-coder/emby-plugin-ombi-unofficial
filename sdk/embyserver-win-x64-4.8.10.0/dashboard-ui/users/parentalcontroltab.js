define(["exports","./../modules/common/globalize.js","./../modules/loading/loading.js","./../modules/common/datetime.js","./../modules/tabbedview/basetab.js","./../components/accessschedule/accessschedule.js","./../modules/common/responsehelper.js","./../modules/emby-elements/emby-checkbox/emby-checkbox.js","./../modules/emby-elements/emby-button/emby-button.js","./../modules/emby-elements/emby-button/paper-icon-button-light.js","./../modules/emby-elements/emby-select/emby-select.js","./../modules/emby-elements/emby-itemscontainer/emby-itemscontainer.js","./../modules/listview/listview.js","./../modules/layoutmanager.js","./../modules/common/itemmanager/itemmanager.js"],function(_exports,_globalize,_loading,_datetime,_basetab,_accessschedule,_responsehelper,_embyCheckbox,_embyButton,_paperIconButtonLight,_embySelect,_embyItemscontainer,_listview,_layoutmanager,_itemmanager){function loadUser(instance,page,user,allParentalRatings){!function(page,user){for(var items=[{name:_globalize.default.translate("Books"),value:"Book"},{name:_globalize.default.translate("Games"),value:"Game"},{name:_globalize.default.translate("OptionBlockChannelContent"),value:"ChannelContent"},{name:_globalize.default.translate("LiveTV"),value:"LiveTvChannel"},{name:_globalize.default.translate("Movies"),value:"Movie"},{name:_globalize.default.translate("Music"),value:"Music"},{name:_globalize.default.translate("Trailers"),value:"Trailer"},{name:_globalize.default.translate("TVShows"),value:"Series"}],html=(html="")+('<h3 class="checkboxListLabel">'+_globalize.default.translate("HeaderBlockItemsWithNoRating")+"</h3>")+'<div class="checkboxList">',i=0,length=items.length;i<length;i++){var item=items[i],checkedAttribute=-1!==user.Policy.BlockUnratedItems.indexOf(item.value)?' checked="checked"':"";html+='<label><input type="checkbox" is="emby-checkbox" class="chkUnratedItem" data-itemtype="'+item.value+'" type="checkbox"'+checkedAttribute+"><span>"+item.name+"</span></label>"}html+="</div>",page.querySelector(".blockUnratedItems").innerHTML=html}(page,user),instance.tags=user.Policy.BlockedTags,function(allParentalRatings,page){for(var rating,html="",ratings=(html+="<option value=''></option>",[]),i=0,length=allParentalRatings.length;i<length;i++){if(rating=allParentalRatings[i],ratings.length){var lastRating=ratings[ratings.length-1];if(lastRating.Value===rating.Value){lastRating.Name+="/"+rating.Name;continue}}ratings.push({Name:rating.Name,Value:rating.Value})}for(i=0,length=ratings.length;i<length;i++)html+="<option value='"+(rating=ratings[i]).Value+"'>"+rating.Name+"</option>";page.querySelector(".selectMaxParentalRating").innerHTML=html}(allParentalRatings,page);var ratingValue="";if(user.Policy.MaxParentalRating)for(var i=0,length=allParentalRatings.length;i<length;i++){var rating=allParentalRatings[i];user.Policy.MaxParentalRating>=rating.Value&&(ratingValue=rating.Value)}page.querySelector(".selectMaxParentalRating").value=ratingValue,page.querySelector(".selectTagMode").value=user.Policy.IsTagBlockingModeInclusive?"include":"",user.Policy.IsAdministrator?page.querySelector(".accessScheduleSection").classList.add("hide"):page.querySelector(".accessScheduleSection").classList.remove("hide"),page.querySelector(".selectMultiRestrictionMode").value=user.Policy.AllowTagOrRating?"any":"all",instance.schedules=user.Policy.AccessSchedules||[],_loading.default.hide(),onValueChange.call(instance);for(var promises=[],itemsContainers=page.querySelectorAll(".itemsContainer"),_i=0,_length=itemsContainers.length;_i<_length;_i++)promises.push(function(itemsContainer,options){return itemsContainer.waitForCustomElementUpgrade().then(function(){itemsContainer.resume(options)})}(itemsContainers[_i],{refresh:!0}));Promise.all(promises)}function saveUser(instance,user,page){user.Policy.MaxParentalRating=page.querySelector(".selectMaxParentalRating").value||null,user.Policy.IsTagBlockingModeInclusive="include"===page.querySelector(".selectTagMode").value,user.Policy.AllowTagOrRating="any"===page.querySelector(".selectMultiRestrictionMode").value,user.Policy.BlockUnratedItems=Array.prototype.filter.call(page.querySelectorAll(".chkUnratedItem"),function(i){return i.checked}).map(function(i){return i.getAttribute("data-itemtype")}),user.Policy.AccessSchedules=instance.schedules,user.Policy.BlockedTags=instance.tags,ApiClient.updateUserPolicy(user.Id,user.Policy).then(function(){_loading.default.hide(),_responsehelper.default.handleConfigurationSavedResponse()})}function showBlockedTagPopup(instance){var options;options={label:_globalize.default.translate("Tag")},Emby.importModule("./modules/prompt/prompt.js").then(function(prompt){return prompt(options)}).then(function(value){var tags=instance.tags;-1===tags.indexOf(value)&&(tags.push(value),instance.refreshTags())})}function onValueChange(){var view=this.view,selectMaxParentalRating=view.querySelector(".selectMaxParentalRating"),selectTagMode=(selectMaxParentalRating.value?view.querySelector(".blockUnratedItems").classList.remove("hide"):view.querySelector(".blockUnratedItems").classList.add("hide"),view.querySelector(".selectTagMode"));selectMaxParentalRating.value&&"include"===selectTagMode.value?view.querySelector(".fldMultiRestrictionMode").classList.remove("hide"):view.querySelector(".fldMultiRestrictionMode").classList.add("hide")}function getDisplayTime(hours){var minutes=0,pct=hours%1;return pct&&(minutes=parseInt(60*pct)),_datetime.default.getDisplayTime(new Date(2e3,1,1,hours,minutes,0,0))}function getAccessScheduleItems(query){var items=this.schedules.map(function(i){return{Type:"GenericListItem",Name:function(dayOfWeek){for(var date=new Date;0<date.getDay();)date.setDate(date.getDate()-1);var index=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"].indexOf(dayOfWeek);return-1!==index?(0<index&&date.setDate(date.getDate()+index),_datetime.default.toLocaleDateString(date,{weekday:"long"})):dayOfWeek}(i.DayOfWeek),CanDelete:!0,Icon:"calendar_month",DeleteType:"remove",ShortOverview:getDisplayTime(i.StartHour)+" - "+getDisplayTime(i.EndHour),OriginalItem:i}});return Promise.resolve({Items:items,TotalRecordCount:items.length})}function getAccessScheduleListOptions(items){return{renderer:_listview.default,options:{moreButton:!1,action:_layoutmanager.default.tv?"menu":"none",buttonCommands:["delete"],fields:["Name","ShortOverview"],defaultBackground:!1,roundImage:!0,commandActions:{deleteItems:function(options){var itemsToRemove=options.items;return this.schedules=this.schedules.filter(function(t){return 0===itemsToRemove.filter(function(i){return i.OriginalItem===t}).length}),Promise.resolve()}.bind(this)}}}}function getBlockedTagsListOptions(items){return{renderer:_listview.default,options:{defaultBackground:!1,roundImage:!0,moreButton:!1,action:_layoutmanager.default.tv?"menu":"none",buttonCommands:["delete"],image:!1,fields:["Name"],commandActions:{deleteItems:function(options){var itemsToRemove=options.items;return this.tags=this.tags.filter(function(t){return 0===itemsToRemove.filter(function(i){return i.Id===t}).length}),Promise.resolve()}.bind(this)}}}}function ParentalControlTab(view,params,options){_basetab.default.apply(this,arguments),this.apiClient=ApiClient,view.addEventListener("change",onValueChange.bind(this));for(var instance=this,btns=(view.querySelector(".btnAddSchedule").addEventListener("click",function(){!function(instance,schedule,index){_accessschedule.default.show({schedule:schedule=schedule||{}}).then(function(updatedSchedule){var schedules=instance.schedules;schedules[index=-1===index?schedules.length:index]=updatedSchedule,instance.refreshAccessSchedule()})}(instance,{},-1)}),view.querySelector(".btnAddBlockedTag").addEventListener("click",function(){showBlockedTagPopup(instance)}),view.querySelector(".userParentalControlForm").addEventListener("submit",function(e){var instance=this,page=instance.view,params=instance.params,params=(_loading.default.show(),params.userId);return ApiClient.getUser(params,!1).then(function(result){saveUser(instance,result,page)}),e.preventDefault(),e.stopPropagation(),!1}.bind(this)),view.querySelectorAll(".userEditTabButton")),i=0,length=btns.length;i<length;i++)btns[i].href=btns[i].getAttribute("data-href")+"?userId="+params.userId+"&serverId="+ApiClient.serverId();var blockedTagsItemsContainer=view.querySelector(".accessScheduleList"),blockedTagsItemsContainer=(blockedTagsItemsContainer.fetchData=getAccessScheduleItems.bind(this),blockedTagsItemsContainer.getListOptions=getAccessScheduleListOptions.bind(this),view.querySelector(".blockedTags"));blockedTagsItemsContainer.fetchData=function(query){var icon=_itemmanager.default.getDefaultIcon({Type:"Tag"}),items=this.tags.map(function(i){return{Type:"GenericListItem",Name:i,Id:i,CanDelete:!0,Icon:icon,DeleteType:"remove",OriginalItem:i}});return Promise.resolve({Items:items,TotalRecordCount:items.length})}.bind(this),blockedTagsItemsContainer.getListOptions=getBlockedTagsListOptions.bind(this)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,Object.assign(ParentalControlTab.prototype,_basetab.default.prototype),ParentalControlTab.prototype.onResume=function(options){_basetab.default.prototype.onResume.apply(this,arguments),_loading.default.show();var page=this.view,params=this.params,params=(_loading.default.show(),ApiClient.getUser(params.userId,!1)),promise2=ApiClient.getParentalRatings(),instance=this;Promise.all([params,promise2]).then(function(responses){loadUser(instance,page,responses[0],responses[1])})},ParentalControlTab.prototype.refreshAccessSchedule=function(){this.view.querySelector(".accessScheduleList").refreshItems()},ParentalControlTab.prototype.refreshTags=function(){this.view.querySelector(".blockedTags").refreshItems()};_exports.default=ParentalControlTab});