define(["exports","./../emby-apiclient/connectionmanager.js","./../emby-elements/emby-button/emby-button.js","./../emby-elements/emby-select/emby-select.js","./../emby-elements/emby-scroller/emby-scroller.js","./../emby-elements/emby-itemscontainer/emby-itemscontainer.js","./../emby-elements/emby-dialogclosebutton/emby-dialogclosebutton.js","./../dialoghelper/dialoghelper.js","./../layoutmanager.js","./../dom.js","./../common/globalize.js","./../focusmanager.js","./../listview/listview.js","./../shortcuts.js","./../common/responsehelper.js"],function(_exports,_connectionmanager,_embyButton,_embySelect,_embyScroller,_embyItemscontainer,_embyDialogclosebutton,_dialoghelper,_layoutmanager,_dom,_globalize,_focusmanager,_listview,_shortcuts,_responsehelper){function ItemAccessDialog(){}function onAllItemsContainerUpgraded(){this.itemsContainer.resume({refresh:!0}).then(function(){var dlg=this.dlg;_focusmanager.default.autoFocus(dlg,{skipIfNotEnabled:!0})}.bind(this))}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,require(["material-icons","formDialogStyle"]),ItemAccessDialog.prototype.getItems=function(query){var instance=this,options=instance.options,options=_connectionmanager.default.getApiClient(options.item);return options.isMinServerVersion("4.8.0.62")?(query=Object.assign({ItemId:instance.options.item.Id,ExcludeUserIds:options.getCurrentUserId()},query),options.getUsersForItemAccess(query).then(function(result){for(var itemAccessItem=instance.options.item,items=result.Items,i=0,length=items.length;i<length;i++)items[i].itemAccessItem=itemAccessItem;return result})):Promise.resolve({Items:[],TotalRecordCount:0})},ItemAccessDialog.prototype.getCardOptions=function(items){var fields=["Name"];return fields.push("ProductionYear"),fields.push("ParentName"),{enableDefaultIcon:!0,action:"custom",fields:fields,draggable:!1,draggableXActions:!1,multiSelect:!1,contextMenu:!1,hoverPlayButton:!1,imageSize:"small",enableUserDataButtons:!1,mediaInfo:!1,itemAccessSelection:!0}},ItemAccessDialog.prototype.getListOptions=function(items){return{renderer:_listview.default,options:this.getCardOptions(items),virtualScrollLayout:"vertical-list"}},ItemAccessDialog.prototype.show=function(options){var item=options.item,dialogOptions={removeOnClose:!0,scrollY:!1,autoFocus:!1},dialogOptions=(_layoutmanager.default.tv?dialogOptions.size="fullscreen":dialogOptions.size="small",_dialoghelper.default.createDialog(dialogOptions)),html=(dialogOptions.classList.add("formDialog"),""),html=(html=(html+='<div class="formDialogHeader">')+'<button type="button" is="emby-dialogclosebutton" closetype="done"></button>'+'<h3 class="formDialogHeaderTitle">',"Playlist"===item.Type?html+=_globalize.default.translate("HeaderManageCollaboration"):html+=_globalize.default.translate("HeaderManageAccess"),html=(html=html+"</h3>"+"</div>")+function(options){var html="",options=options.item,html=(html=(html=(html=html+'<div is="emby-scroller" data-horizontal="false" data-forcescrollbar="true" data-focusscroll="true" class="formDialogContent virtualScrollerScrollContainer">'+'<div class="scrollSlider">')+'<form class="dialogContentInner dialog-content-centered padded-left padded-right">'+'<div class="selectContainer flex-shrink-zero">')+('<select is="emby-select" class="selectVisibility emby-select-dynamicfielddescription" required="required" label="'+_globalize.default.translate("Visibility")+'" data-menu="custom">'))+('<option value="private" data-description="'+_globalize.default.translate("MakePrivateDescription")+'">'+_globalize.default.translate("Private")+"</option>");return"Playlist"===options.Type?html+='<option value="public" data-description="'+_globalize.default.translate("MakePublicDescription")+'">'+_globalize.default.translate("Collaborative")+"</option>":html+='<option value="public" data-description="'+_globalize.default.translate("MakePublicDescription")+'">'+_globalize.default.translate("Public")+"</option>",html=(html=(html=(html=(html=(html=(html=(html=(html+="</select>")+'<div class="fieldDescription dynamicFieldDescription hide"></div>'+"</div>")+'<div class="userItemAccessContainer hide">'+'<div class="flex secondaryText" style="margin:2em 0 0;">')+('<h3 class="flex-grow" style="margin:0;">'+_globalize.default.translate("User"))+"</h3>")+('<h3 style="margin:0;">'+_globalize.default.translate("Access")))+"</h3>"+"</div>")+'<div is="emby-itemscontainer" data-virtualscrolllayout="vertical-grid" class="itemsContainer allItemsContainer itemsContainer-defaultCardSize vertical-wrap padded-bottom-page">'+"</div>")+"</div>"+"</form>")+"</div>"+"</div>"}(options),dialogOptions.innerHTML=html,dialogOptions.querySelector(".selectVisibility")),html=(html.addEventListener("change",function(e){var instance=this,options=instance.options,item=options.item,apiClient=_connectionmanager.default.getApiClient(item);return(e="public"===e.target.value?apiClient.makePublic(item.Id):apiClient.makePrivate(item.Id)).then(function(){return apiClient.getItem(apiClient.getCurrentUserId(),options.item.Id,{fields:"ShareLevel",ExcludeFields:"Chapters,MediaSources,MediaStreams,People,Overview,Subviews"}).then(function(item){options.item=item,instance.itemsContainer.refreshItems()})})}.bind(this)),html.singleValue=item.CanMakePublic?"private":"public",this.dlg=dialogOptions,this.options=options,dialogOptions.querySelector(".allItemsContainer")),item=(html.addEventListener("action-null",function(e){_layoutmanager.default.tv&&e.target.closest(".listItem").querySelector("select").click()}.bind(this)),html.fetchData=this.getItems.bind(this),html.getListOptions=this.getListOptions.bind(this),html.addEventListener("change",function(e){var item=this.options.item,e=e.target,itemsContainer=this.itemsContainer,itemElement=_shortcuts.default.getItemElementFromChildNode(e,!1,itemsContainer),itemElement=itemsContainer.getItemFromElement(itemElement),e=e.value;_connectionmanager.default.getApiClient(itemElement).updateUserItemAccess({UserIds:[itemElement.Id],ItemIds:[item.Id],ItemAccess:e}).then(function(){itemsContainer.refreshItems()},_responsehelper.default.handleErrorResponse)}.bind(this)),html.parentContainer=html.closest(".userItemAccessContainer"),this.itemsContainer=html,dialogOptions.addEventListener("opened",function(){var itemsContainer=this.itemsContainer;itemsContainer.resume?onAllItemsContainerUpgraded.call(this):_dom.default.addEventListener(itemsContainer,"upgraded",onAllItemsContainerUpgraded.bind(this),{once:!0})}.bind(this)),function(){return this.result?(this.cleanup(),Promise.resolve()):(this.cleanup(),Promise.reject())}.bind(this));return _dialoghelper.default.open(dialogOptions).then(item,item)},ItemAccessDialog.prototype.closeDialog=function(){var dlg=this.dlg;dlg&&_dialoghelper.default.close(dlg)},ItemAccessDialog.prototype.cleanup=function(){this.listName=null,this.options=null,this.dlg=null,this.itemsContainer=null};_exports.default=ItemAccessDialog});