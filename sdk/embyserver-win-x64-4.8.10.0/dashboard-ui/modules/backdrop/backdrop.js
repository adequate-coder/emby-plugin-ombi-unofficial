define(["exports","./../emby-apiclient/connectionmanager.js","./../dom.js","./../common/playback/playbackmanager.js","./../common/methodtimer.js"],function(_exports,_connectionmanager,_dom,_playbackmanager,_methodtimer){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0;var uiDependencies=["css!modules/backdrop/style.css"],supportsAsyncDecodedImages=_dom.default.supportsAsyncDecodedImages(),supportsObjectFit=CSS.supports("object-fit","contain"),supportsImgSrcSet="srcset"in HTMLImageElement.prototype,RotationIntervalMs=24e3;uiDependencies.length&&require(uiDependencies);var backdropContainer,supportsCssAnimations=CSS.supports("animation-name","a");function enableAnimation(){return supportsCssAnimations&&_dom.default.supportsEventListenerOnce()}function enableRotation(){return!!enableAnimation()}function Backdrop(){}function mapImageSourceToUrl(source){return source.url}function getImageInfoId(imageInfo){var id=imageInfo.id;return id=id||(imageInfo.id=imageInfo.sources.map(mapImageSourceToUrl).join("|"))}function getFallbackImageSource(imageInfo){return imageInfo.sources[imageInfo.sources.length-1]}function mapSourceToString(source){return source.url+" "+source.width+"w"}Backdrop.prototype.load=function(imageInfo,animate,parent,existingBackdropImage){var img=new Image,self=(img.setAttribute("data-id",getImageInfoId(imageInfo)),img.setAttribute("draggable","false"),img.setAttribute("fetchpriority","low"),supportsObjectFit&&(supportsAsyncDecodedImages&&img.setAttribute("decoding","async"),img.setAttribute("loading","lazy")),img.classList.add("backdropImage"),!1===imageInfo.coverImage&&img.classList.add("backdropImage-contain"),this);this.previousBackdropImage=existingBackdropImage;img.onload=function(){var backdropImage,onAnimationComplete;!self.isDestroyed&&(backdropImage=supportsObjectFit?img:document.createElement("div"),supportsObjectFit||(backdropImage.style.backgroundImage="url('"+getFallbackImageSource(imageInfo).url+"')"),backdropImage.classList.add("backdropImage","displayingBackdropImage"),!1===imageInfo.coverImage&&backdropImage.classList.add("backdropImage-contain"),self.elem=backdropImage,internalBackdrop(!0),animate&&enableAnimation()&&backdropImage.classList.add("backdropImageFadeIn"),supportsObjectFit||parent.appendChild(backdropImage),img.style.visibility=null,enableAnimation())?(onAnimationComplete=function(){_dom.default.removeEventListener(backdropImage,_dom.default.whichAnimationEvent(),onAnimationComplete,{once:!0}),_dom.default.removeEventListener(backdropImage,_dom.default.whichAnimationCancelEvent(),onAnimationComplete,{once:!0}),self.removePreviousBackdropImage()},_dom.default.addEventListener(backdropImage,_dom.default.whichAnimationEvent(),onAnimationComplete,{once:!0}),_dom.default.addEventListener(backdropImage,_dom.default.whichAnimationCancelEvent(),onAnimationComplete,{once:!0})):self.removePreviousBackdropImage()},supportsObjectFit&&(img.style.visibility="hidden"),img.src=getFallbackImageSource(imageInfo).url,supportsImgSrcSet&&supportsObjectFit&&1<imageInfo.sources.length&&function(img,sources){(sources=sources.slice(0)).pop(),img.sizes="100vw",img.srcset=sources.map(mapSourceToString).join(",")}(img,imageInfo.sources),supportsObjectFit&&parent.appendChild(img),this.imageInfo=imageInfo},Backdrop.prototype.removePreviousBackdropImage=function(){var existingBackdropImage=this.previousBackdropImage;existingBackdropImage&&(this.previousBackdropImage=null,existingBackdropImage.remove())},Backdrop.prototype.cancelAnimation=function(){var elem=this.elem;elem&&(elem.classList.remove("backdropImageFadeIn"),this.elem=null)},Backdrop.prototype.destroy=function(){this.isDestroyed=!0,this.cancelAnimation(),this.removePreviousBackdropImage()};var hasExternalBackdrop,currentLoadingBackdrop,hasInternalBackdrop,rotationInterval,backgroundContainer=document.querySelector(".backgroundContainer");function getBackdropContainer(){return(backdropContainer=backdropContainer||document.querySelector(".backdropContainer"))||((backdropContainer=document.createElement("div")).classList.add("backdropContainer"),document.body.insertBefore(backdropContainer,document.body.firstChild)),backdropContainer}function clearBackdrop(clearAll){clearRotation(),currentLoadingBackdrop&&(currentLoadingBackdrop.destroy(),currentLoadingBackdrop=null),getBackdropContainer().innerHTML="",clearAll&&(hasExternalBackdrop=!1),internalBackdrop(!1)}function setBackgroundContainerBackgroundEnabled(){hasInternalBackdrop||hasExternalBackdrop?(backgroundContainer.classList.add("withBackdrop"),getBackdropContainer().classList.add("withBackdrop")):(backgroundContainer.classList.remove("withBackdrop"),getBackdropContainer().classList.remove("withBackdrop"))}function internalBackdrop(enabled){hasInternalBackdrop=enabled,setBackgroundContainerBackgroundEnabled()}function setBackdropImage(imageInfo,animate){var elem=getBackdropContainer(),existingBackdropImage=elem.querySelector(".displayingBackdropImage");if(!currentLoadingBackdrop||getImageInfoId(currentLoadingBackdrop.imageInfo)!==getImageInfoId(imageInfo)){if(existingBackdropImage){if(existingBackdropImage.getAttribute("data-id")===getImageInfoId(imageInfo))return;existingBackdropImage.classList.remove("displayingBackdropImage")}currentLoadingBackdrop&&(currentLoadingBackdrop.destroy(),currentLoadingBackdrop=null);var instance=new Backdrop;instance.load(imageInfo,animate,elem,existingBackdropImage),currentLoadingBackdrop=instance}}function getImageSources(apiClient,itemId,imageOptions){var widths=apiClient.getDefaultImageSizes();return widths.push(function(widths){var width=_dom.default.getWindowSize().innerWidth;return widths.includes(width)?width:(width=100*Math.floor(width/100),Math.min(width,1920))}(widths)),apiClient.getImageUrls(itemId,imageOptions,{widths:widths})}function getPrimaryImageInfos(item,imageOptions,apiClient){var _item$ImageTags;return null!=(_item$ImageTags=item.ImageTags)&&_item$ImageTags.Primary||item.PrimaryImageTag?[{sources:getImageSources(apiClient,item.PrimaryImageItemId||item.Id||item.ItemId,Object.assign(imageOptions,{type:"Primary",tag:(null==(_item$ImageTags=item.ImageTags)?void 0:_item$ImageTags.Primary)||item.PrimaryImageTag,EnableImageEnhancers:!1})),coverImage:item.PrimaryImageAspectRatio&&1.4<=item.PrimaryImageAspectRatio}]:[]}function getImageInfos(items,imageOptions,enablePrimaryImageBeforeInherited,allowPrimaryImage){for(var list=[],i=0,length=items.length;i<length;i++){var itemImages=function(item,imageOptions,enablePrimaryImageBeforeInherited,allowPrimaryImage){item=item.ProgramInfo||item,imageOptions=imageOptions||{};var apiClient=_connectionmanager.default.getApiClient(item);if(item.BackdropImageTags&&0<item.BackdropImageTags.length)return item.BackdropImageTags.map(function(imgTag,index){return{sources:getImageSources(apiClient,item.BackdropItemId||item.Id,Object.assign(imageOptions,{type:"Backdrop",tag:imgTag,index:index})),coverImage:!0}});if(enablePrimaryImageBeforeInherited){enablePrimaryImageBeforeInherited=getPrimaryImageInfos(item,imageOptions,apiClient);if(enablePrimaryImageBeforeInherited.length)return enablePrimaryImageBeforeInherited}if(item.ParentBackdropItemId&&item.ParentBackdropImageTags&&item.ParentBackdropImageTags.length)return item.ParentBackdropImageTags.map(function(imgTag,index){return{sources:getImageSources(apiClient,item.ParentBackdropItemId,Object.assign(imageOptions,{type:"Backdrop",tag:imgTag,index:index})),coverImage:!0}});if(allowPrimaryImage){enablePrimaryImageBeforeInherited=getPrimaryImageInfos(item,imageOptions,apiClient);if(enablePrimaryImageBeforeInherited.length)return enablePrimaryImageBeforeInherited;if(item.ParentPrimaryImageTag)return[{sources:getImageSources(apiClient,item.ParentPrimaryImageItemId,Object.assign(imageOptions,{type:"Primary",tag:item.ParentPrimaryImageTag,EnableImageEnhancers:!1})),coverImage:!1}]}return[]}(items[i],imageOptions,enablePrimaryImageBeforeInherited,allowPrimaryImage);list.push.apply(list,babelHelpers.toConsumableArray(itemImages))}return list}var animationEnabledByCaller,currentRotatingImages=[],currentRotationIndex=-1;function onRotationInterval(force){!0!==force&&_playbackmanager.default.isPlayingLocally(["Video","Game","Book"])||((force=currentRotationIndex+1)>=currentRotatingImages.length&&(force=0),setBackdropImage(currentRotatingImages[currentRotationIndex=force],animationEnabledByCaller),animationEnabledByCaller=!0)}function clearRotation(){rotationInterval&&rotationInterval.destroy(),rotationInterval=null,currentRotatingImages=[],currentRotationIndex=-1}_exports.default={getBackdropsFromOptions:function(items,options){return getImageInfos(items,(options=options||{}).imageOptions,options.enablePrimaryImageBeforeInherited,options.allowPrimaryImage)},setBackdrops:function(items,options){(items=getImageInfos(items,(options=options||{}).imageOptions,options.enablePrimaryImageBeforeInherited,options.allowPrimaryImage)).length?function(images,enableImageRotation,enableAnimation){!function(a,b){if(a===b)return 1;if(null!=a&&null!=b&&a.length===b.length){for(var i=0;i<a.length;++i)if(a[i]!==b[i])return;return 1}}(images,currentRotatingImages)&&(clearRotation(),animationEnabledByCaller=!(currentRotationIndex=-1)!==enableAnimation,1<(currentRotatingImages=images).length&&!1!==enableImageRotation&&enableRotation()&&(rotationInterval=new _methodtimer.default({onInterval:onRotationInterval,timeoutMs:RotationIntervalMs,type:"interval"})),onRotationInterval(!0))}(items,options.enableImageRotation,options.enableAnimation):clearBackdrop()},setBackdrop:function(item,imageOptions){var imageInfo;(imageInfo=item?"string"==typeof item?{sources:[{url:item}],coverImage:!0}:getImageInfos([item],imageOptions)[0]:imageInfo)?(clearRotation(),setBackdropImage(imageInfo,!0)):clearBackdrop()},clear:clearBackdrop,externalBackdrop:function(enabled){hasExternalBackdrop=enabled,setBackgroundContainerBackgroundEnabled()},hasBackdrop:function(){return null!=currentLoadingBackdrop},getCurrentImageInfo:function(){return currentLoadingBackdrop?currentLoadingBackdrop.imageInfo:null}}});