define(["exports","./commandprocessor.js","./common/inputmanager.js","./emby-apiclient/connectionmanager.js","./common/playback/playbackmanager.js","./common/itemmanager/itemmanager.js","./layoutmanager.js"],function(_exports,_commandprocessor,_inputmanager,_connectionmanager,_playbackmanager,_itemmanager,_layoutmanager){function getItemElementFromChildNode(child,isMainElement,itemsContainer){itemsContainer=(itemsContainer=null==itemsContainer?void 0:itemsContainer.getItemSelector())||".card,.listItem,.epgRow,.dataGridItem";return isMainElement?child.closest(itemsContainer):child.closest("[data-type],"+itemsContainer)}function getItemFromElement(element,itemsContainer){var item;return item=(itemsContainer=itemsContainer||element.closest(".itemsContainer"))&&(item=itemsContainer.getItemFromElement(element))?item:{Type:element.getAttribute("data-type"),Id:element.getAttribute("data-id"),ServerId:element.getAttribute("data-serverid"),IsFolder:"true"===element.getAttribute("data-isfolder"),Status:element.getAttribute("data-status")||null,MediaType:element.getAttribute("data-mediatype")||null,ChannelId:element.getAttribute("data-channelid")||null,TimerId:element.getAttribute("data-timerid")||null,SeriesTimerId:element.getAttribute("data-seriestimerid")||null}}function showContextMenu(itemElement,options){options.itemsContainer||(options.itemsContainer=itemElement.closest(".itemsContainer"));var itemsContainer=options.itemsContainer;return Promise.all([function(button,itemsContainer){var itemFromElement=getItemFromElement(button=getItemElementFromChildNode(button,null,itemsContainer),itemsContainer),button=itemFromElement.Type;if(!_itemmanager.default.getItemController(button).isSingleItemFetchRequired(button))return Promise.resolve(itemFromElement);var id=itemFromElement.Id;if(!id)return Promise.resolve(itemFromElement);var apiClient=_connectionmanager.default.getApiClient(itemFromElement);switch(button){case"VirtualFolder":return function(apiClient,id){return apiClient.getVirtualFolders().then(function(result){return result.Items.filter(function(u){return u.ItemId===id})[0]})}(apiClient,id);case"User":return apiClient.getUser(id);case"Timer":return apiClient.getLiveTvTimer(id);case"SeriesTimer":return apiClient.getLiveTvSeriesTimer(id)}return(itemsContainer=["ShareLevel"]).push("SyncStatus"),itemsContainer.push("ContainerSyncStatus"),apiClient.getItem(apiClient.getCurrentUserId(),id,{fields:itemsContainer.join(","),ExcludeFields:"Chapters,Overview,People,MediaStreams,Subviews"}).then(function(fullItem){return fullItem.PlaylistItemId=itemFromElement.PlaylistItemId,fullItem.CollectionId=itemFromElement.CollectionId,fullItem.PlaylistId=itemFromElement.PlaylistId,fullItem})}(itemElement,itemsContainer),Emby.importModule("./modules/itemcontextmenu.js")]).then(function(responses){var item=responses[0];return function(item){return null!=(item=_connectionmanager.default.getApiClient(item))&&item.getCurrentUserId()?item.getCurrentUser():Promise.resolve(null)}(item).then(function(user){options.positionTo&&!options.itemElement&&(options.itemElement=itemElement);var commandOptions=Object.assign({},itemsContainer.getCommandOptions(item));return responses[1].show(Object.assign(commandOptions,{items:[item],play:!0,queue:!0,playAllFromHere:!item.IsFolder,queueAllFromHere:!item.IsFolder,user:user,multiSelect:((itemsContainer.currentListOptions||{}).options||{}).multiSelect,programInfo:!0},options))})})}function notifyItemsContainerOfCommandResult(itemsContainer,result){itemsContainer.onCommandResult(result)}function executeAction(originalEvent,itemElement,itemsContainer,target,action){if(target=target||itemElement,!(itemElement=getItemElementFromChildNode(itemElement,null,itemsContainer)))return Promise.resolve();var item=getItemFromElement(itemElement,itemsContainer);if("custom"!==action){var options={positionTo:target,itemElement:itemElement,itemsContainer:itemsContainer,eventType:originalEvent.type,eventTarget:originalEvent.target};switch(action){case"togglecheckbox":if(null!=originalEvent&&originalEvent.target.closest(".dragHandle"))return;break;case"menu":case"info":originalEvent&&"click"===originalEvent.type?(options.positionY=_layoutmanager.default.tv?"top":"bottom",options.positionX=_layoutmanager.default.tv?"right":"after"):null!=(_originalEvent$detail=originalEvent.detail)&&_originalEvent$detail.originalEvent&&(options.positionY=_layoutmanager.default.tv?"top":"bottom",options.positionX="after",options.positionClientX=originalEvent.detail.originalEvent.clientX,options.positionClientY=originalEvent.detail.originalEvent.clientY);var _originalEvent$detail=function(itemsContainer){return function(result){return itemsContainer&&notifyItemsContainerOfCommandResult(itemsContainer,result),Promise.resolve(result)}}(itemsContainer);return showContextMenu(itemElement,options).then(_originalEvent$detail),Promise.resolve();case"link":itemsContainer&&(options.context=((itemsContainer.currentListOptions||{}).options||{}).context)}target=function(command,itemsContainer){return function(result){return itemsContainer&&notifyItemsContainerOfCommandResult(itemsContainer,{command:command,result:result}),Promise.resolve(result)}}(action,itemsContainer);return _commandprocessor.default.executeCommand(action,[item],options).then(target)}itemElement.dispatchEvent(new CustomEvent("action-null",{detail:{item:item,originalEvent:originalEvent},cancelable:!1,bubbles:!0})),Promise.resolve()}function onClick(e){var target=e.target,itemElement=target.closest(".itemAction");if(itemElement){var actionElement=itemElement,action=actionElement.getAttribute("data-action");if(action||(actionElement=actionElement.closest("[data-action]"))&&(action=actionElement.getAttribute("data-action")),action){var itemsContainer=target.closest(".itemsContainer");switch(action){case"openlink":case"default":case"none":break;default:executeAction(e,itemElement,itemsContainer,actionElement,action)}switch(action){case"multiselect":case"openlink":case"toggleitemchecked":break;default:return"default"!==action&&e.preventDefault(),e.stopPropagation(),!1}}}}function onCommand(e){var target,itemsContainer,scroller,itemElement,cmd=e.detail.command;switch(cmd){case"play":case"playpause":itemsContainer=(target=e.target).closest(".itemsContainer"),!(itemElement=getItemElementFromChildNode(target,null,itemsContainer))||itemsContainer&&"true"===itemsContainer.getAttribute("data-skipplaycommands")||_playbackmanager.default.isPlayingMediaType(["Audio","Video"])||(e.preventDefault(),e.stopPropagation(),executeAction(e,itemElement,itemsContainer,itemElement,cmd));break;case"resume":case"record":case"menu":case"info":itemsContainer=(target=e.target).closest(".itemsContainer"),(itemElement=getItemElementFromChildNode(target,null,itemsContainer))&&(e.preventDefault(),e.stopPropagation(),executeAction(e,itemElement,itemsContainer,itemElement,cmd));break;case"pageup":(itemsContainer=(target=e.target).closest(".itemsContainer"))&&(scroller=itemsContainer.closest("[is=emby-scroller]"))&&"false"===scroller.getAttribute("data-horizontal")&&(itemsContainer.pageUp(target),e.preventDefault(),e.stopPropagation());break;case"pagedown":(itemsContainer=(target=e.target).closest(".itemsContainer"))&&(scroller=itemsContainer.closest("[is=emby-scroller]"))&&"false"===scroller.getAttribute("data-horizontal")&&(itemsContainer.pageDown(target),e.preventDefault(),e.stopPropagation());break;case"end":(itemsContainer=(target=e.target).closest(".itemsContainer"))&&(scroller=itemsContainer.closest("[is=emby-scroller]"))&&"false"===scroller.getAttribute("data-horizontal")&&(itemsContainer.focusLast(),e.preventDefault(),e.stopPropagation());break;case"select":"DIV"===(target=e.target).tagName&&!target.closest("a,button,.itemAction")&&(itemsContainer=target.closest(".itemsContainer"),itemElement=getItemElementFromChildNode(target,null,itemsContainer))&&((itemElement.querySelector(".itemAction")||itemElement).click(),e.preventDefault(),e.stopPropagation())}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0;_exports.default={on:function(context,options){!1!==(options=options||{}).click&&context.addEventListener("click",onClick),!1!==options.command&&_inputmanager.default.on(context,onCommand)},off:function(context,options){options=options||{},context.removeEventListener("click",onClick),!1!==options.command&&_inputmanager.default.off(context,onCommand)},onClick:onClick,getShortcutAttributesHtml:function(item,options){var type,dataAttributes="";return!options.isBoundListItem&&((type=item.Type)&&(dataAttributes+=' data-type="'+type+'"'),(type=item.ServerId||options.serverId)&&(dataAttributes+=' data-serverid="'+type+'"'),(type=item.MediaType)&&(dataAttributes+=' data-mediatype="'+type+'"'),type=item.ChannelId)&&(dataAttributes+=' data-channelid="'+type+'"'),options.isVirtualList||(type=item.Id||item.ItemId)&&(dataAttributes+=' data-id="'+type+'"'),dataAttributes},getShortcutAttributes:function(item,options){var type,dataAttributes=[];return!options.isBoundListItem&&((type=item.Type)&&dataAttributes.push({name:"data-type",value:type}),(type=item.ServerId||options.serverId)&&dataAttributes.push({name:"data-serverid",value:type}),(type=item.MediaType)&&dataAttributes.push({name:"data-mediatype",value:type}),type=item.ChannelId)&&dataAttributes.push({name:"data-channelid",value:type}),options.isVirtualList||(type=item.Id||item.ItemId)&&dataAttributes.push({name:"data-id",value:type}),dataAttributes},getItemElementFromChildNode:getItemElementFromChildNode,getItemFromChildNode:function(child,isMainElement,itemsContainer){return(child=getItemElementFromChildNode(child,isMainElement,itemsContainer))?getItemFromElement(child,itemsContainer):null},getItemFromElement:getItemFromElement}});