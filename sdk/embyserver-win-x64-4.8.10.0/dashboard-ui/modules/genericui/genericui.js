define(["exports","./../emby-apiclient/connectionmanager.js","./../viewmanager/basesettingsview.js","./../emby-elements/emby-button/emby-button.js","./../emby-elements/emby-dialogclosebutton/emby-dialogclosebutton.js","./../appheader/appheader.js","./../common/globalize.js","./../layoutmanager.js","./../genericedit/genericedit.js","./../loading/loading.js","./../dialoghelper/dialoghelper.js","./../emby-apiclient/events.js","./../common/input/api.js","./../common/responsehelper.js","./../maintabsmanager.js","./../emby-elements/emby-scroller/emby-scroller.js","./../focusmanager.js"],function(_exports,_connectionmanager,_basesettingsview,_embyButton,_embyDialogclosebutton,_appheader,_globalize,_layoutmanager,_genericedit,_loading,_dialoghelper,_events,_api,_responsehelper,_maintabsmanager,_embyScroller,_focusmanager){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,require(["css!modules/genericui/genericui.css"]);var currentViewData,currentPage,currentDlg,isDataValid,infoChangedEventName="UIPageInfoChanged";function dashboardConfirm(message,title,callback){var options;options=message,Emby.importModule("./modules/common/dialogs/confirm.js").then(function(confirm){return confirm(options)}).then(function(){callback(!0)},function(){callback(!1)})}function onServerEvent(e,apiClient,updatedData){var mainContent;e.type===infoChangedEventName&&currentViewData&&updatedData&&updatedData.PageId===currentViewData.PageId&&(updatedData.ViewId===currentViewData.ViewId?updatedData.IsPageChangeInfo||(currentViewData=updatedData,mainContent=(e=currentDlg||currentPage).querySelector(".mainContent"),updatePageData(updatedData,e,updatedData.EditObjectContainer,mainContent,currentViewData.EditObjectContainer.Object,currentViewData.EditObjectContainer.DefaultObject)):updatedData.IsPageChangeInfo&&showStage(updatedData,currentPage))}function onInvalid(e){null!==e.target.offsetParent&&(isDataValid=!1)}function onButtonClick(e){var button=e.target.closest("BUTTON");if(button||(button=e.target.closest("INPUT"))&&!button.getAttribute("data-data1")&&(button=null),e.Data1||button&&!button.hasAttribute("disabled")){e.preventDefault();var commandId=e.Data1||(button?button.getAttribute("data-data1"):null),itemId=e.Data2||(button?button.getAttribute("data-data2"):null),confirmationPrompt=e.ConfirmationPrompt||(button?button.getAttribute("data-prompt"):null);e.Caption||button&&button.getAttribute("data-caption");if(commandId){e.stopPropagation();var data=null;if(!_genericedit.default.runCommand(commandId,(currentDlg||currentPage).querySelector(".mainContent"),itemId)){if(currentViewData.EditObjectContainer){button=(currentDlg||currentPage).querySelector(".mainContent");if(_genericedit.default.getItemValues(currentViewData.EditObjectContainer,button),data=JSON.stringify(currentViewData.EditObjectContainer.Object),"WizardNext"===commandId||"WizardFinish"===commandId||"DialogOk"===commandId||"PageSave"===commandId){e=button.closest("FORM");if(e&&(isDataValid=!0,e.reportValidity(),!isDataValid||!1===currentViewData.EditObjectContainer.isDataValid))return}}confirmationPrompt?dashboardConfirm(confirmationPrompt,0,wrapRunCommand):wrapRunCommand(!0)}}}function wrapRunCommand(run){run&&runUiCommand(currentViewData.PageId,currentViewData.ViewType,commandId,data,itemId).then(function(){},_responsehelper.default.handleErrorResponse)}}function updatePageData(stage,page,container,htmlElement){_genericedit.default.setFormValues(container,htmlElement);for(var container=page.querySelector(".mainTitle"),htmlElement=(container&&(container.innerHTML=stage.Caption),page.querySelector(".mainSubTitle")),buttons=(htmlElement&&stage.SubCaption&&(htmlElement.innerHTML=(container=stage.SubCaption)&&0!==container.length?container.split("\n").join("<br />"):null),(page.closest(".dialog")||page).querySelectorAll(".btnButtonItem, .wizardbutton, .pagebutton, .dialogHeaderButton")),n=0;n<buttons.length;n++)for(var btn=buttons[n],btnCommand=btn.getAttribute("data-data1"),i=0;i<stage.Commands.length;i++){var cmd=stage.Commands[i];btnCommand===cmd.CommandType&&(cmd.IsVisible?(btn.classList.remove("genericeditbutton-hide"),btn.parentElement.classList.contains("formDialogFooterItem")&&btn.parentElement.classList.remove("hide")):(btn.classList.add("genericeditbutton-hide"),btn.parentElement.classList.contains("formDialogFooterItem")&&btn.parentElement.classList.add("hide")),cmd.IsEnabled&&(btn.classList.contains("btnOk")||btn.classList.contains("btnSave"))?btn.classList.add("button-submit"):btn.classList.remove("button-submit"),"WizardNext"===btnCommand&&cmd.IsEnabled&&btn.disabled?_focusmanager.default.focus(btn):"WizardNext"===btnCommand&&cmd.IsEnabled&&cmd.SetFocus&&!btn.hasAttribute("focusSet")&&(btn.setAttribute("focusSet","true"),_focusmanager.default.focus(btn)),"WizardFinish"===btnCommand&&cmd.IsEnabled&&cmd.SetFocus&&!btn.hasAttribute("focusSet")&&(btn.setAttribute("focusSet","true"),_focusmanager.default.focus(btn)),btn.disabled=!cmd.IsEnabled,cmd.Caption)&&btn.classList.contains("raised")&&(btn.innerText=cmd.Caption)}}function onDialogQueryClose(dlg,forceClose){var btnDialogCancel=dlg.querySelector(".btnDialogCancel:not(.genericeditbutton-hide)");return btnDialogCancel?btnDialogCancel.click():forceClose?onCloseConfirm():dashboardConfirm('Do you want to hide the dialog?\nIt will remain active and you can return through the buttons at the right or bottom.\nPress "Cancel" and use the dialog buttons to close.',0,function(pressedOk){pressedOk&&onCloseConfirm()}),!1;function onCloseConfirm(){_dialoghelper.default.close(dlg),currentDlg&&currentDlg!==dlg&&_dialoghelper.default.close(currentDlg),currentDlg=null}}function checkCloseDialog(){currentDlg&&(_dialoghelper.default.close(currentDlg),currentDlg=null)}function runUiCommand(pageId,viewType,commandId,data,itemId){return _loading.default.show(),function(pageId,commandId,data,itemId){var apiClient=_connectionmanager.default.currentApiClient(),url=apiClient.getUrl("UI/Command");return apiClient.ajax({type:"POST",url:url,data:JSON.stringify({PageId:pageId,CommandId:commandId,Data:data,ItemId:itemId,ClientLocale:_globalize.default.getCurrentLocale()}),contentType:"application/json",dataType:"json"})}(pageId,commandId,data,itemId).then(function(setupStage){if("PageSave"===commandId&&_responsehelper.default.handleConfigurationSavedResponse(),setupStage.RedirectViewUrl){checkCloseDialog();var url=setupStage.RedirectViewUrl;Emby.importModule("./modules/approuter.js").then(function(appRouter){appRouter.show(url)})}else if(setupStage.PageId!==pageId||setupStage.ViewId!==currentViewData.ViewId)return showStage(setupStage,currentPage);_loading.default.hide(),currentViewData=setupStage;var containerElement=currentDlg||currentPage,mainContent=containerElement.querySelector(".mainContent");return updatePageData(setupStage,containerElement,setupStage.EditObjectContainer,mainContent,currentViewData.EditObjectContainer.Object,currentViewData.EditObjectContainer.DefaultObject),Promise.resolve()})}function setTabs(viewData,view){if(viewData.TabPageInfos&&1<viewData.TabPageInfos.length){view.classList.add("withTabs");for(var tabs=viewData.TabPageInfos,currentIndex=0,i=0;i<tabs.length;i++)tabs[i].name=tabs[i].DisplayName,tabs[i].href=tabs[i].Href,tabs[i].navMenuId=tabs[i].NavKey,tabs[i].index=i,tabs[i].PageId===viewData.PageId&&!function(view,title){(view=view.querySelector(".mainTitle"))&&(view.innerText=title)}(view,tabs[currentIndex=i].name);_maintabsmanager.default.setTabs(view,currentIndex,function(){return tabs})}else view.classList.remove("withTabs")}function showStageWizard(setupStage){return new Promise(function(resolve,reject){require(["text!modules/genericui/wizardpage.template.html"]).then(function(template){!function(setupStage,editObjectContainer,template,genericeditor){for(var dialogOptions={removeOnClose:!0,scrollY:!0,size:_layoutmanager.default.tv?"fullscreen":"small",enableHistory:!1,autoFocus:!0,queryCloseHandler:onDialogQueryClose},dlg=(setupStage.ShowDialogFullScreen&&(dialogOptions.scrollY=!1,dialogOptions.size="fullscreen"),_dialoghelper.default.createDialog(dialogOptions)),dialogOptions=(dlg.classList.add("formDialog"),dlg.innerHTML=_globalize.default.translateDocument(template[0]),setupStage.ShowDialogFullScreen),mainContent=dlg.querySelector(".mainContent"),wizardButtons=(dialogOptions&&(mainContent.style.height="100%",(template=dlg.querySelector(".dialogForm")).style.maxWidth="none",template.style.height="100%",(dialogOptions=dlg.querySelector(".dialogContentInner")).classList.remove("dialog-content-centered","padded-left","padded-right"),dialogOptions.style.paddingTop="0",dialogOptions.style.paddingBottom="0",dialogOptions.style.height="100%",dialogOptions.parentNode.style.height="100%",dlg.querySelector(".formDialogContent").style.overflow="hidden"),"Wizard"===setupStage.ViewType&&((template=dlg.querySelector(".btnOk")).parentNode.removeChild(template),dlg.querySelector(".formDialogFooter").classList.add("formDialogFooter-wizard")),dlg.querySelectorAll(".wizardbutton")),n=0;n<wizardButtons.length;n++){var btn=wizardButtons.item(n);btn.setAttribute("data-data2",setupStage.PluginId),btn.addEventListener("click",onButtonClick)}return mainContent.removeEventListener("click",onButtonClick),mainContent.removeEventListener("invalid",onInvalid),genericeditor.renderForm(editObjectContainer,mainContent).then(function(){return mainContent.addEventListener("click",onButtonClick),mainContent.addEventListener("invalid",onInvalid,{capture:!0}),updatePageData(setupStage,dlg,editObjectContainer,mainContent),_loading.default.hide(),checkCloseDialog(),currentDlg=dlg,_dialoghelper.default.open(dlg),Promise.resolve()})}(setupStage,setupStage.EditObjectContainer,template,_genericedit.default).then(resolve,reject)})})}function showStage(viewData,page){return currentPage=page||currentPage,"Wizard"===(currentViewData=viewData).ViewType||"Dialog"===viewData.ViewType?showStageWizard(viewData):(checkCloseDialog(),function(viewData,page){setTabs(viewData,page),_appheader.default.setTitle(viewData.Caption||"");for(var mainContentParent=page.querySelector(".mainContentParent"),mainContent=page.querySelector(".mainContent"),editObjectContainer=viewData.EditObjectContainer,pageButtons=mainContentParent.querySelectorAll(".pagebutton"),n=0;n<pageButtons.length;n++){var btn=pageButtons.item(n);btn.setAttribute("data-data2",viewData.PluginId),btn.addEventListener("click",onButtonClick)}return mainContent.removeEventListener("click",onButtonClick),mainContent.removeEventListener("invalid",onInvalid),editObjectContainer.EditorRoot.DisplayName=null,editObjectContainer.EditorRoot.Description=null,_genericedit.default.renderForm(editObjectContainer,mainContent).then(function(){return mainContent.addEventListener("click",onButtonClick),mainContent.addEventListener("invalid",onInvalid,{capture:!0}),updatePageData(viewData,page,editObjectContainer,mainContent),_loading.default.hide(),Promise.resolve()})}(viewData,currentPage))}function View(view,params){_basesettingsview.default.apply(this,arguments);var pageId=(params?params.PageId:null)||"";pageId.length?(function(pageId){var apiClient=_connectionmanager.default.currentApiClient(),pageId=apiClient.getUrl("UI/View",{PageId:pageId,ClientLocale:_globalize.default.getCurrentLocale()});return apiClient.fetch({url:pageId,type:"GET",dataType:"json"})}(pageId).then(function(viewData){showStage(viewData,view)},_responsehelper.default.handleErrorResponse),_events.default.on(_api.default,infoChangedEventName,onServerEvent)):_responsehelper.default.handleErrorResponse({message:"No page id was specified. Cannot load page!"})}Object.assign(View.prototype,_basesettingsview.default.prototype),View.prototype.onInputCommand=function(e){var command=e.detail.command;if("back"===command)if(function(stage){for(var i=0;i<stage.Commands.length;i++){var cmd=stage.Commands[i];if("PageBack"===cmd.CommandType)return!0===cmd.IsVisible}}(currentViewData))return runUiCommand(currentViewData.PageId,currentViewData.ViewType,"PageBack",null,null).then(function(){},_responsehelper.default.handleErrorResponse),void e.preventDefault();_basesettingsview.default.prototype.onInputCommand.apply(this,arguments)},View.prototype.onResume=function(options){_basesettingsview.default.prototype.onResume.apply(this,arguments),_events.default.on(_api.default,infoChangedEventName,onServerEvent)},View.prototype.onPause=function(){_events.default.off(_api.default,infoChangedEventName,onServerEvent),_basesettingsview.default.prototype.onPause.apply(this,arguments)},View.prototype.destroy=function(){_basesettingsview.default.prototype.destroy.apply(this,arguments),_events.default.off(_api.default,infoChangedEventName,onServerEvent)};_exports.default=View});