define(["exports","./../emby-apiclient/connectionmanager.js","./../common/globalize.js","./../layoutmanager.js","./../loading/loading.js","./../dialoghelper/dialoghelper.js","./../emby-elements/emby-button/paper-icon-button-light.js","./../emby-elements/emby-button/emby-button.js","./../emby-elements/emby-scroller/emby-scroller.js","./../emby-elements/emby-itemscontainer/emby-itemscontainer.js","./../emby-elements/emby-dialogclosebutton/emby-dialogclosebutton.js","./../common/input/api.js","./../emby-apiclient/events.js","./../common/servicelocator.js","./../listview/listview.js","./../dom.js"],function(_exports,_connectionmanager,_globalize,_layoutmanager,_loading,_dialoghelper,_paperIconButtonLight,_embyButton,_embyScroller,_embyItemscontainer,_embyDialogclosebutton,_api,_events,_servicelocator,_listview,_dom){function renderJob(context,job,dialogOptions,originalOptions){Emby.importModule("./modules/sync/sync.js").then(function(syncDialog){syncDialog.renderForm({elem:context.querySelector(".syncJobFormContent"),dialogOptions:dialogOptions,dialogOptionsFn:function(dialogOptions){return function(targetId){return Promise.resolve(dialogOptions)}}(dialogOptions),readOnlySyncTarget:!0,mode:originalOptions.mode}).then(function(){!function(context,job,editOptions){var selectProfile=context.querySelector(".selectProfile");selectProfile&&(selectProfile.value=job.Profile||"",triggerChange(selectProfile));selectProfile=context.querySelector(".selectQuality");selectProfile&&(selectProfile.value=job.Quality||"",triggerChange(selectProfile));selectProfile=context.querySelector(".selectJobContainer");selectProfile&&(selectProfile.value=job.Container||"",triggerChange(selectProfile));selectProfile=context.querySelector(".selectVideoCodec");selectProfile&&(selectProfile.value=job.VideoCodec||"",triggerChange(selectProfile));selectProfile=context.querySelector(".selectAudioCodec");selectProfile&&(selectProfile.value=job.AudioCodec||"",triggerChange(selectProfile));selectProfile=context.querySelector(".chkUnwatchedOnly");selectProfile&&(selectProfile.checked=job.UnwatchedOnly);selectProfile=context.querySelector(".chkSyncNewContent");selectProfile&&(selectProfile.checked=job.SyncNewContent);selectProfile=context.querySelector(".txtItemLimit");selectProfile&&(selectProfile.value=job.ItemLimit);selectProfile=context.querySelector(".txtBitrate");job.Bitrate?selectProfile.value=job.Bitrate/1e6:selectProfile.value="";selectProfile=editOptions.Targets.filter(function(t){return t.Id===job.TargetId})[0],editOptions=selectProfile?selectProfile.Name:"",selectProfile=context.querySelector(".selectSyncTarget");selectProfile&&(selectProfile.value=editOptions)}(context,job,dialogOptions)})})}function triggerChange(select){select.dispatchEvent(new CustomEvent("change",{bubbles:!0}))}function saveJob(context,id,apiClient){_loading.default.show(),apiClient.getJSON(apiClient.getUrl("Sync/Jobs/"+id)).then(function(job){Emby.importModule("./modules/sync/sync.js").then(function(syncDialog){syncDialog.setJobValues(job,context),apiClient.ajax({url:apiClient.getUrl("Sync/Jobs/"+id),type:"POST",data:JSON.stringify(job),contentType:"application/json"}).then(function(){_servicelocator.appHost.supports("sync")&&require(["localsync"],function(localSync){localSync.sync()}),_loading.default.hide(),_dialoghelper.default.close(context)})})},function(error){_loading.default.hide(),_dialoghelper.default.close(context)})}function onItemsContainerUpgraded(){this.resume({refresh:!0})}function onOpened(){var itemsContainer=this.querySelector(".jobItems");itemsContainer.resume?onItemsContainerUpgraded.call(itemsContainer):_dom.default.addEventListener(itemsContainer,"upgraded",onItemsContainerUpgraded.bind(this),{once:!0})}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0;_exports.default={show:function(options){var apiClient=_connectionmanager.default.getApiClient(options.serverId),id=options.jobId,dlgElementOptions={removeOnClose:!0,scrollY:!1,autoFocus:!1},dlg=(_layoutmanager.default.tv?dlgElementOptions.size="fullscreen":dlgElementOptions.size="medium",_dialoghelper.default.createDialog(dlgElementOptions)),dlgElementOptions=(dlg.classList.add("formDialog"),""),itemsContainer=(dlgElementOptions=(dlgElementOptions=(dlgElementOptions+='<div class="formDialogHeader">')+'<button type="button" is="emby-dialogclosebutton"></button>'+'<h3 class="formDialogHeaderTitle">')+("convert"===options.mode?_globalize.default.translate("Convert"):_globalize.default.translate("Download"))+"</h3>",_servicelocator.appHost.supports("externallinks")&&(dlgElementOptions+='<a href="https://support.emby.media/support/solutions/articles/44001162174-sync" target="_blank" is="emby-linkbutton" class="paper-icon-button-light noautofocus btnHelp flex align-items-center dialogHeaderButton button-help"><i class="md-icon">&#xe887;</i></a>'),dlgElementOptions=(dlgElementOptions=(dlgElementOptions=(dlgElementOptions=(dlgElementOptions+="</div>")+'<div is="emby-scroller" data-horizontal="false" data-forcescrollbar="true" data-focusscroll="true" class="formDialogContent">'+'<div class="scrollSlider">')+'<form class="dialogContentInner dialog-content-centered syncJobForm padded-left padded-right">'+'<div class="syncJobFormContent"></div>')+'<div class="jobItems" is="emby-itemscontainer" data-monitor="SyncJobItems" data-virtualscrolllayout="vertical-grid"></div>'+'<div class="formDialogFooter">')+('<button is="emby-button" type="submit" class="raised button-submit block formDialogFooterItem"><span>'+_globalize.default.translate("Save")+"</span></button>"),dlg.innerHTML=dlgElementOptions=(dlgElementOptions=dlgElementOptions+"</div>"+"</form>")+"</div>"+"</div>",dlg.querySelector("form").addEventListener("submit",function(e){return saveJob(dlg,id,apiClient),e.preventDefault(),!1}),dlg.querySelector(".jobItems"));function onSyncJobMessage(e,apiClient,job){String(job.Id)===id&&itemsContainer.refreshItems()}return itemsContainer.fetchData=function(query){var id=this.id,apiClient=this.apiClient,serverId=apiClient.serverId(),mode=this.mode;return apiClient.getJSON(apiClient.getUrl("Sync/JobItems",Object.assign(query,{JobId:id,AddMetadata:!0}))).then(function(result){for(var items=result.Items,i=0,length=items.length;i<length;i++){var item=items[i];item.Type="SyncJobItem",item.ServerId=serverId,"convert"===mode&&(item.SyncJobType="Convert")}return result})}.bind({apiClient:apiClient,id:id,mode:options.mode}),itemsContainer.getListOptions=function(items){return{renderer:_listview.default,options:{enableDefaultIcon:!0,action:"none",fields:["Name","SyncJobItemStatus"],draggable:!1,multiSelect:!1,contextMenu:!0,hoverPlayButton:!1,draggableXActions:!1,imageSize:"small",enableUserDataButtons:!1,mediaInfo:!1},virtualScrollLayout:"vertical-list"}}.bind(this),function(context,id,apiClient,originalOptions){_loading.default.show(),apiClient.getJSON(apiClient.getUrl("Sync/Jobs/"+id)).then(function(job){return apiClient.getJSON(apiClient.getUrl("Sync/Options",{UserId:job.UserId,ItemIds:job.RequestedItemIds&&job.RequestedItemIds.length?job.RequestedItemIds.join(""):null,ParentId:job.ParentId,Category:job.Category,TargetId:job.TargetId})).then(function(options){renderJob(context,job,options,originalOptions),_loading.default.hide()})},function(error){_loading.default.hide(),_dialoghelper.default.close(context)})}(dlg,id,apiClient,options),dlg.addEventListener("opened",onOpened),dlgElementOptions=_dialoghelper.default.open(dlg),_events.default.on(_api.default,"SyncJobUpdated",onSyncJobMessage),dlgElementOptions.then(function(){return _events.default.off(_api.default,"SyncJobUpdated",onSyncJobMessage),Promise.reject()})}}});