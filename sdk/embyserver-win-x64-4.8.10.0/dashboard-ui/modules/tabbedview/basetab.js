define(["exports","./../dom.js","./../layoutmanager.js","./../backdrop/backdrop.js","./../shortcuts.js","./../common/usersettings/usersettings.js","./../common/itemmanager/itemmanager.js","./../mediainfo/mediainfo.js","./../cardbuilder/cardbuilder.js","./../skinmanager.js","./../emby-apiclient/connectionmanager.js","./../common/globalize.js","./../focusmanager.js","./../maintabsmanager.js"],function(_exports,_dom,_layoutmanager,_backdrop,_shortcuts,_usersettings,_itemmanager,_mediainfo,_cardbuilder,_skinmanager,_connectionmanager,_globalize,_focusmanager,_maintabsmanager){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0;var decodingAttribute=_dom.default.supportsAsyncDecodedImages()?' decoding="async"':"";function findScroller(instance){var view;instance.scroller||(view=instance.view,instance.scroller=view.classList.contains("scrollFrameY")?view:view.querySelector(".scrollFrameY"))}function BaseTab(view,params,options){this.view=view,this.params=params,this.options=options,findScroller(this),this.requestedItemFields="BasicSyncInfo,CanDelete"}function onFocusPreviewItemFetched(instance,item,itemElement){instance.enableFocusPreview()&&instance.showFocusPreview(item,itemElement),item&&item.ServerId?instance._enableBackdrops&&_backdrop.default.setBackdrop(item):_backdrop.default.clear()}function fetchAndShowFocusPreview(instance,focused){var apiClient,item=instance.getFocusPreviewItem(focused);item&&instance.refetchItemForFocusPreview()&&instance.enableFocusPreview()?(apiClient=_connectionmanager.default.getApiClient(item)).getItem(apiClient.getCurrentUserId(),item.Id).then(function(item){onFocusPreviewItemFetched(instance,item,focused)}):onFocusPreviewItemFetched(instance,item,focused)}function clearSelectedInfoTimer(instance){var selectedItemInfoTimeout=instance.selectedItemInfoTimeout;selectedItemInfoTimeout&&(clearTimeout(selectedItemInfoTimeout),instance.selectedItemInfoTimeout=null)}function startSelectedInfoTimer(instance){clearSelectedInfoTimer(instance),instance.selectedItemInfoTimeout=setTimeout(function(){var focused;this.paused||((focused=this._focusedElement)?fetchAndShowFocusPreview(this,focused):onFocusPreviewItemFetched(this,null))}.bind(instance),700)}var backgroundContainer=document.querySelector(".backgroundContainer"),backdropContainer=document.querySelector(".backdropContainer"),appHeader=document.querySelector(".skinHeader");function fillFocusPreview(instance,elem,item,itemElement){item=item.CurrentProgram||item,_backdrop.default.setBackdrop(item);var focusPreviewImageElement,focusPreviewTitle=elem.querySelector(".focusPreviewTitle"),focusPreviewSecondaryTitle=elem.querySelector(".focusPreviewSecondaryTitle"),names=[],scrollDirection=instance.scrollDirection(),apiClient=_connectionmanager.default.getApiClient(item),itemForTitle="Timer"===item.Type&&item.ProgramInfo||item,logoImage=(apiClient&&(logoImage="x"===scrollDirection||"title"!==function(item){return"TvChannel"===item.Type?null:("MusicAlbum"!==item.Type&&"Audio"!==item.Type&&"MusicVideo"!==item.Type||item.ImageTags&&item.ImageTags.Logo)&&_usersettings.default.getEnableLogoAsTitle(_globalize.default.getCurrentLocale())?"title":"float"}(itemForTitle)?null:apiClient.getLogoImageUrl(itemForTitle,{maxHeight:120},_skinmanager.default.getPreferredLogoImageTypes())),item.SeriesName&&(apiClient=item.SeriesName,logoImage&&(apiClient='<img draggable="false" loading="lazy"'+decodingAttribute+' class="focusPreviewTitleImg" alt="'+apiClient+'" src="'+logoImage+'" />',logoImage=null),names.push(apiClient)),item.Name&&(item.EpisodeTitle||item.IsSeries)&&(apiClient=item.Name,logoImage&&(apiClient='<img draggable="false" loading="lazy"'+decodingAttribute+' class="focusPreviewTitleImg" alt="'+apiClient+'" src="'+logoImage+'" />',logoImage=null),names.push(apiClient)),item.Name&&(apiClient=_itemmanager.default.getDisplayName(item,{}),logoImage&&(apiClient='<img draggable="false" loading="lazy"'+decodingAttribute+' class="focusPreviewTitleImg" alt="'+apiClient+'" src="'+logoImage+'" />',logoImage=null),names.push(apiClient)),focusPreviewTitle.innerHTML=names[0]||"",1<names.length?(focusPreviewSecondaryTitle.innerHTML=names[1]||"",focusPreviewSecondaryTitle.classList.remove("hide")):focusPreviewSecondaryTitle.classList.add("hide"),elem.querySelector(".focusPreviewMediaInfo")),apiClient="Program"===item.Type?_mediainfo.default.getSecondaryMediaInfoHtml(item,{timerIndicator:!0,channelName:!1,officialRating:!0,programIndicator:!0}):_mediainfo.default.getPrimaryMediaInfoHtml(item),focusPreviewTitle=(logoImage.innerHTML=apiClient,"x"===scrollDirection?null:item.Overview);elem.querySelector(".focusPreviewOverview").innerHTML=focusPreviewTitle||"",focusPreviewTitle?elem.classList.remove("hide"):elem.classList.add("hide"),instance.enableFocusPreviewImage()&&(focusPreviewImageElement=elem.querySelector(".focusPreviewImageElement"),instance._focusPreviewImageItem=itemForTitle,focusPreviewImageElement.waitForCustomElementUpgrade().then(function(){focusPreviewImageElement.refreshItems()})),elem.classList.remove("hide"),itemElement&&"x"===scrollDirection&&(names=itemElement.getBoundingClientRect(),focusPreviewSecondaryTitle=_dom.default.getWindowSize().innerWidth,logoImage=elem.style,names.left<=.7*focusPreviewSecondaryTitle?(logoImage.left=Math.min(names.left,.6*focusPreviewSecondaryTitle)+"px",logoImage.right=null):(logoImage.right="3%",logoImage.left="initial"))}function fillWithRandomItem(instance,elem,item,itemElement){var apiClient=_connectionmanager.default.getApiClient(item),itemTypes="Movie,Series,Game,MusicAlbum,MusicArtist,Trailer";switch(item.CollectionType){case"movies":itemTypes="Movie";break;case"tvshows":itemTypes="Series";break;case"games":itemTypes="Game";break;case"musicvideos":itemTypes="MusicVideo";break;case"homevideos":itemTypes="Video";break;case"music":case"audiobooks":itemTypes="MusicAlbum,MusicArtist"}!function(instance,apiClient,types,parentId){return types={SortBy:"Random",Limit:1,Recursive:!0,IncludeItemTypes:types,ImageTypes:"Backdrop",ParentId:parentId,EnableTotalRecordCount:!1,ImageTypeLimit:1,Fields:instance.getRequestedItemFields(),EnableImageTypes:instance.getRequestedImageTypes()+",Backdrop"},apiClient.getItems(apiClient.getCurrentUserId(),types)}(instance,apiClient,itemTypes,item.Id).then(function(result){fillFocusPreview(instance,elem,result.Items[0]||item,itemElement)})}function getScrollerNavOutDestination(direction){return direction===_focusmanager.default.directions.up?appHeader:null}BaseTab.prototype.scrollDirection=function(){var _this$options;return(null==(_this$options=this.options)?void 0:_this$options.scrollDirection)||"y"},BaseTab.prototype.enablePushDownFocusPreview=function(){return!1},BaseTab.prototype.enableFocusPreview=function(){return!!_layoutmanager.default.tv&&("x"===this.scrollDirection()||this.enablePushDownFocusPreview())},BaseTab.prototype.createFocusPreviewElement=function(){var cssClass="focusPreviewContainer",cssClass=("x"===this.scrollDirection()?cssClass+=" focusPreviewContainer-horizontal":cssClass+=" padded-left padded-right padded-top-page ",'<div class="hide '+cssClass+'"></div>'),cssClass=(this.view.insertAdjacentHTML("afterbegin",cssClass),this.view.querySelector(".focusPreviewContainer"));return this.fillFocusPreviewContainer(cssClass),cssClass},BaseTab.prototype.getFocusPreviewElement=function(){var elem=this._focusPreviewElement;return elem||(this._focusPreviewElement=elem=this.createFocusPreviewElement()),elem},BaseTab.prototype.fillFocusPreviewContainer=function(elem){var scrollDirection=this.scrollDirection(),readOnlyContentStyle=this.enablePushDownFocusPreview()?' style="padding:0 .75em;width:40ch;"':"",itemsContainer=(elem.innerHTML='<div class="flex flex-direction-row align-items-center  focusPreviewContainer-inner"><div is="emby-itemscontainer" class="itemsContainer focusPreviewImageElement align-items-center hide "></div><div class="readOnlyContent verticalFieldItems verticalFieldItems-condensed"'+readOnlyContentStyle+'>\n            <h3 style="margin:0;" class="focusPreviewTitle verticalFieldItem-condensed"></h3>\n            <div class="focusPreviewSecondaryTitle hide verticalFieldItem-condensed"></div>\n            <div class="secondaryText focusPreviewMediaInfo mediaInfoItems verticalFieldItem-condensed" style="font-size:92%;"></div>\n            <div class="secondaryText focusPreviewOverview verticalFieldItem-condensed '+("x"===scrollDirection?" focusPreviewOverview-horizontal":"")+'"></div>\n        </div></div>',elem.querySelector(".itemsContainer"));itemsContainer.fetchData=function(){var item=this._focusPreviewImageItem,items=[];return item&&items.push(item),Promise.resolve({Items:items,TotalRecordCount:items.length})}.bind(this),(itemsContainer.parentContainer=itemsContainer).getListOptions=function(){return{renderer:_cardbuilder.default,options:{shape:"auto",overlayText:!0,fields:[],action:"none",imageClass:"focusPreviewImageContainer",multiSelect:!1,contextMenu:!1,ratingButton:!1,playedButton:!1,cardClass:"focusPreviewImageCard",cardBoxClass:"focusPreviewImageCardBox",defaultIcon:!1,defaultBackground:!1,typeIndicator:!1,playedIndicator:!1,syncIndicator:!1,timerIndicator:!1,randomDefaultBackground:!1,staticElement:!0,progress:!1,enableUserData:!1,draggable:!1,moreButton:!1,programIndicators:!1,keepImageAnimation:!0,preferLogo:"x"===this.scrollDirection(),paddedImage:!1},virtualScrollLayout:"vertical-grid"}}.bind(this),itemsContainer.waitForCustomElementUpgrade().then(function(){itemsContainer.resume({})})},BaseTab.prototype.autoFocus=function(options){options=Object.assign({skipIfNotEnabled:!0},options);var elem,view=this.view;return view&&(elem=_focusmanager.default.autoFocus(view,options))?elem:(!options.skipIfNotEnabled||_focusmanager.default.isAutoFocusEnabled())&&(elem=_maintabsmanager.default.focus())||null},BaseTab.prototype.showFocusPreview=function(item,itemElement){var elem=this.getFocusPreviewElement(item);if(!item||item.IsCategory)fillFocusPreview(this,elem,{}),this.hideFocusPreviewElementUsingDisplay()&&elem.classList.add("hide");else switch(item.Type){case"Channel":case"CollectionFolder":fillWithRandomItem(this,elem,item,itemElement);break;default:fillFocusPreview(this,elem,item,itemElement)}},BaseTab.prototype.hideFocusPreviewElementUsingDisplay=function(){return!0},BaseTab.prototype.refetchItemForFocusPreview=function(){return!1},BaseTab.prototype.getFocusPreviewItem=function(element){return _shortcuts.default.getItemFromChildNode(element,!0)},BaseTab.prototype.enableFocusPreviewImage=function(){return"x"===this.scrollDirection()},BaseTab.prototype.onFocusIn=function(elem){this._focusedElement=elem,startSelectedInfoTimer(this)},BaseTab.prototype.onFocusOut=function(){this._focusedElement=null,startSelectedInfoTimer(this)},BaseTab.prototype.fillFocusPreviewIfNeeded=function(){if(this.enableFocusPreview()||this.enableBackdropsOnFocus()){var elem=document.activeElement||document.body;if(this.view.contains(elem)){var itemsContainer=elem.closest(".itemsContainer");if(itemsContainer&&elem.matches(itemsContainer.getItemSelector()))return}(elem=this.view.querySelector(".card"))&&elem.closest(".itemsContainer")&&fetchAndShowFocusPreview(this,elem)}},BaseTab.prototype.getRequestedItemFields=function(){var fields=this.requestedItemFields;return this.enableFocusPreview()&&(fields+=",Overview,CommunityRating,CriticRating,OfficialRating,PremiereDate,ProductionYear,Container"),fields},BaseTab.prototype.getRequestedImageTypes=function(){var fields="Primary,Backdrop,Thumb";return this.enableFocusPreview()&&(fields+=",Logo"),fields},BaseTab.prototype.enableBackdropsOnFocus=function(){return!!this.enableFocusPreview()||_usersettings.default.enableBackdrops()},BaseTab.prototype.addFocusBehavior=function(element){this._enableBackdrops=_layoutmanager.default.tv&&this.enableBackdropsOnFocus(),(this._enableBackdrops||this.enableFocusPreview())&&(this.boundonItemsContainerFocusIn||(this.boundonItemsContainerFocusIn=function(e){e=e.target,this.onFocusIn(e)}.bind(this)),this.boundonItemsContainerFocusOut||(this.boundonItemsContainerFocusOut=function(e){this.onFocusOut()}.bind(this)),_dom.default.addEventListener(element,"focus",this.boundonItemsContainerFocusIn,{capture:!0,passive:!0}),_dom.default.addEventListener(element,"focusout",this.boundonItemsContainerFocusOut,{passive:!0}))},BaseTab.prototype.hasFocus=function(){var activeElement=document.activeElement,view=this.view;return activeElement&&view&&view.contains(activeElement)},BaseTab.prototype.scrollToBeginning=function(){var scroller=this.scroller;scroller&&scroller.scrollToBeginning()},BaseTab.prototype.loadTemplate=function(){return Promise.resolve()},BaseTab.prototype.onTemplateLoaded=function(){findScroller(this),this.view.classList.add("focuscontainer-x");var focusContainerElem=this.getFocusContainerElement();focusContainerElem&&(focusContainerElem.classList.add("focuscontainer-y","navout-up"),focusContainerElem.getNavOutDestination=getScrollerNavOutDestination)},BaseTab.prototype.getFocusContainerElement=function(){return this.scroller},BaseTab.prototype.getApiClient=function(){var _this$options2;return this.apiClient||((_this$options2=this.params.serverId||(null==(_this$options2=this.options)?void 0:_this$options2.serverId))?_connectionmanager.default.getApiClient(_this$options2):_connectionmanager.default.currentApiClient())},BaseTab.prototype.onBeginResume=function(options){this.paused=!1;var scroller=this.scroller;scroller&&scroller.beginResume&&scroller.beginResume(options)},BaseTab.prototype.onResume=function(options){this.paused=!1;var scroller=this.scroller,scroller=(scroller&&scroller.resume&&scroller.resume(options),this.enableFocusPreview());(scroller||this._focusPreviewElement)&&(this.enablePushDownFocusPreview()&&(this.scroller.setHeaderBindingEnabled(!scroller),options=this.scroller.querySelector(".scrollSlider.padded-top-page")||this.scroller.querySelector(".padded-top-page"),scroller?(this.scroller.classList.add("tab-scroller-withfocuspreview"),options&&options.classList.add("tab-scroller-withfocuspreview-padded-top-page"),backgroundContainer.classList.add("backgroundContainer-withfocuspreview"),backdropContainer.classList.add("backdropContainer-withfocuspreview"),"rtl"===document.dir?backdropContainer.classList.add("backdropContainer-withfocuspreview-rtl"):backdropContainer.classList.remove("backdropContainer-withfocuspreview-rtl"),appHeader.classList.add("appHeader-withfocuspreview"),this.scroller.setFocusScroll("center")):(this.scroller.classList.remove("tab-scroller-withfocuspreview"),options&&options.classList.remove("tab-scroller-withfocuspreview-padded-top-page"),backgroundContainer.classList.remove("backgroundContainer-withfocuspreview"),backdropContainer.classList.remove("backdropContainer-withfocuspreview","backdropContainer-withfocuspreview-rtl"),appHeader.classList.remove("appHeader-withfocuspreview"))),!scroller)&&this._focusPreviewElement&&this.showFocusPreview(null)},BaseTab.prototype.onPause=function(){this.paused=!0;var scroller=this.scroller;scroller&&scroller.pause&&scroller.pause(),clearSelectedInfoTimer(this),(this.enableFocusPreview()||this._focusPreviewElement)&&(this._focusPreviewElement&&this.showFocusPreview(null),this.enablePushDownFocusPreview())&&(backgroundContainer.classList.remove("backgroundContainer-withfocuspreview"),backdropContainer.classList.remove("backdropContainer-withfocuspreview","backdropContainer-withfocuspreview-rtl"),appHeader.classList.remove("appHeader-withfocuspreview"))},BaseTab.prototype.destroy=function(){this.paused=null,this.scroller=null,this.view=null,this.params=null,this.options=null,this.apiClient=null,this._focusedElement=null,this._enableBackdrops=null,this._focusPreviewElement=null,clearSelectedInfoTimer(this)};_exports.default=BaseTab});