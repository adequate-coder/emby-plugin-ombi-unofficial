define(["exports","./../modules/viewmanager/baseview.js","./../modules/common/textencoding.js","./../modules/loading/loading.js","./../modules/emby-apiclient/connectionmanager.js","./../modules/emby-elements/emby-button/emby-button.js","./../modules/emby-elements/emby-progressbar/emby-progressbar.js","./../modules/listview/listview.js","./../modules/common/methodtimer.js","./../modules/common/input/api.js","./../modules/emby-apiclient/events.js","./../modules/layoutmanager.js","./scheduledtaskcontroller.js"],function(_exports,_baseview,_textencoding,_loading,_connectionmanager,_embyButton,_embyProgressbar,_listview,_methodtimer,_api,_events,_layoutmanager,_scheduledtaskcontroller){function ensureTaskCategory(instance,task,refreshItemsContainer){var index,html="";if(instance.itemsContainers[task.Category])return refreshItemsContainer&&-1!==(index=(_itemsContainer=instance.itemsContainers[task.Category]).indexOfItemId(task.Id))&&_itemsContainer.onItemUpdated(index,task),Promise.resolve();var _itemsContainer=document.createElement("div");_itemsContainer.className="verticalSection verticalSection-extrabottompadding",_itemsContainer.style.marginBottom="1.8em",html=(html='<div class="sectionTitleContainer" style="margin:.5em 0;"><h2 class="sectionTitle secondaryText">')+_textencoding.default.htmlEncode(task.Category),_itemsContainer.innerHTML=html=(html=html+"</h2>"+"</div>")+'<div is="emby-itemscontainer" class="itemsContainer verticalList">'+"</div>";instance.view.querySelector(".divScheduledTasks").appendChild(_itemsContainer);var itemsContainer=_itemsContainer.querySelector(".itemsContainer");if(itemsContainer.fetchData=function(){var instance=this.instance,category=this.category,instance=instance.tasks.filter(function(task){return task.Category===category});return Promise.resolve(instance)}.bind({instance:instance,category:task.Category}),itemsContainer.getListOptions=function(items){return{renderer:_listview.default,options:{moreButton:!1,roundImage:!0,action:_layoutmanager.default.tv?"menu":null,multiSelect:!1,image:!!_layoutmanager.default.tv,largeHeading:!0,buttonCommands:["scheduledtask_start","scheduledtask_stop"],fields:["Name","ScheduledTaskRunInfo","Description"],draggable:!1,draggableXActions:!1}}}.bind({instance:instance,category:task.Category}),instance.itemsContainers[task.Category]=itemsContainer,refreshItemsContainer)return itemsContainer.waitForCustomElementUpgrade().then(function(){return itemsContainer.refreshItems()});Promise.resolve()}function compareTasks(a,b){return(a=a.Category+" "+a.Name)===(b=b.Category+" "+b.Name)?0:a<b?-1:1}function importTasks(instance,tasks,refreshItemContainers){for(var i=0,length=(tasks=tasks.sort(compareTasks)).length;i<length;i++){var task=tasks[i];instance.updateTask(task)}for(var _i=0,_length=tasks.length;_i<_length;_i++)ensureTaskCategory(instance,tasks[_i],refreshItemContainers)}function ensureItemsContainers(instance,refreshItemContainers){return instance.getApiClient().getScheduledTasks({isHidden:!1}).then(function(tasks){importTasks(instance,tasks,refreshItemContainers)})}function startInterval(instance){instance.getApiClient().startMessageListener("ScheduledTasksInfo","1000,1000"),instance.pollInterval&&(instance.pollInterval.destroy(),instance.pollInterval=null),instance.pollInterval=new _methodtimer.default({onInterval:function(){if(!this.getApiClient().isMessageChannelOpen())return ensureItemsContainers(this,!0)}.bind(instance),timeoutMs:1e4,type:"interval"})}function View(view,params){_baseview.default.apply(this,arguments),params.serverId=_connectionmanager.default.currentApiClient().serverId(),this.tasks=[],this.itemsContainers={}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,Object.assign(View.prototype,_baseview.default.prototype),View.prototype.updateTask=function(item){item.Type="ScheduledTask",item.ServerId=this.getApiClient().serverId(),item.RouteUrl="/scheduledtask?id="+item.Id+"&serverId="+item.ServerId;for(var tasks=this.tasks,i=0,length=tasks.length;i<length;i++)if(tasks[i].Id===item.Id)return void(tasks[i]=item);tasks.push(item)},View.prototype.onResume=function(options){_baseview.default.prototype.onResume.apply(this,arguments),startInterval(this),this.boundonScheduledTasksUpdate||(this.boundonScheduledTasksUpdate=function(e,apiClient,info){apiClient.serverId()===(null==(apiClient=this.params)?void 0:apiClient.serverId)&&importTasks(this,info,!0)}.bind(this)),_events.default.on(_api.default,"ScheduledTasksInfo",this.boundonScheduledTasksUpdate);var instance=this;return ensureItemsContainers(this,!1).then(function(){for(var itemContainers=instance.view.querySelectorAll(".itemsContainer"),promises=[],i=0,length=itemContainers.length;i<length;i++)promises.push(itemContainers[i].waitForCustomElementUpgrade());return Promise.all(promises).then(function(){for(var _i2=0,_length2=itemContainers.length;_i2<_length2;_i2++)itemContainers[_i2].resume(options);_loading.default.hide()})})},View.prototype.onPause=function(){_baseview.default.prototype.onPause.apply(this,arguments),this.boundonScheduledTasksUpdate&&_events.default.off(_api.default,"ScheduledTasksInfo",this.boundonScheduledTasksUpdate),function(instance){instance.getApiClient().stopMessageListener("ScheduledTasksInfo"),instance.pollInterval&&(instance.pollInterval.destroy(),instance.pollInterval=null)}(this);for(var itemContainers=this.view.querySelectorAll(".itemsContainer"),i=0,length=itemContainers.length;i<length;i++)itemContainers[i].pause()},View.prototype.destroy=function(){_baseview.default.prototype.destroy.apply(this,arguments),this.tasks=null,this.itemsContainers=null};_exports.default=View});