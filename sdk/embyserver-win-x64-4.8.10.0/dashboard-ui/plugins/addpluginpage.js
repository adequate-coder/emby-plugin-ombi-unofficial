define(["exports","./../modules/viewmanager/baseview.js","./../modules/loading/loading.js","./../modules/common/globalize.js","./../modules/emby-elements/emby-button/emby-button.js","./../modules/emby-elements/emby-select/emby-select.js","./../modules/emby-elements/emby-scroller/emby-scroller.js","./../modules/emby-elements/emby-itemscontainer/emby-itemscontainer.js","./../modules/common/servicelocator.js","./../modules/emby-apiclient/connectionmanager.js","./../modules/listview/listview.js","./../modules/dom.js","./../modules/common/textencoding.js"],function(_exports,_baseview,_loading,_globalize,_embyButton,_embySelect,_embyScroller,_embyItemscontainer,_servicelocator,_connectionmanager,_listview,_dom,_textencoding){function renderPackage(pkg,installedPlugins,pluginSecurityInfo,page){var installedPlugins=installedPlugins.filter(function(ip){return(ip.Id||"").toLowerCase()===(pkg.guid||"").toLowerCase()})[0],owner=(!function(packageInfo,page,installedPlugin){for(var html="",i=0,length=packageInfo.versions.length;i<length;i++){var version=packageInfo.versions[i];html+='<option value="'+version.versionStr+"|"+version.classification+'">'+version.versionStr+" ("+version.classification+")</option>"}var selectmenu=page.querySelector(".selectVersion");selectmenu.innerHTML=html,installedPlugin||((installedPlugin=page.querySelector(".pCurrentVersion")).classList.add("hide"),installedPlugin.innerHTML=""),(page=(page=packageInfo.versions.filter(function(current){return"Release"===current.classification})[0])||packageInfo.versions.filter(function(current){return"Beta"===current.classification})[0])&&(installedPlugin=page.versionStr+"|"+page.classification,selectmenu.value=installedPlugin)}(pkg,page,installedPlugins),page.querySelector(".pluginName").innerHTML=_textencoding.default.htmlEncode(pkg.name||""),"Server"===pkg.targetSystem&&(page.querySelector(".btnInstallDiv").classList.remove("hide"),page.querySelector(".nonServerMsg").classList.add("hide"),page.querySelector(".pSelectVersion").classList.remove("hide")),pkg.shortDescription?(page.querySelector(".tagline").classList.remove("hide"),page.querySelector(".tagline").innerHTML=_textencoding.default.htmlEncode(pkg.shortDescription||"")):page.querySelector(".tagline").classList.add("hide"),page.querySelector(".overview").innerHTML=_dom.default.stripScripts(pkg.overview||""),pkg.owner);"luke"!==owner&&"ebr"!==owner||(owner="Emby"),page.querySelector(".developer").innerHTML=_textencoding.default.htmlEncode(owner||""),function(page,pkg,pluginSecurityInfo){var regStatus,nowTime,expDateTime;_servicelocator.appHost.supports("externalpremium")&&(pkg.isPremium?(page.querySelector(".premiumPackage").classList.remove("hide"),regStatus="",pkg.isRegistered?regStatus=(regStatus+="<p style='color:green;'>")+_globalize.default.translate("MessageFeatureIncludedWithSupporter"):(expDateTime=new Date(pkg.expDate).getTime())<=(nowTime=Date.now())?regStatus=(regStatus+="<p style='color:red;'>")+_globalize.default.translate("MessageTrialExpired"):expDateTime>new Date(1970,1,1).getTime()&&(regStatus=(regStatus+="<p style='color:blue;'>")+_globalize.default.translate("MessageTrialWillExpireIn").replace("{0}",Math.round(expDateTime-nowTime)/864e5)),regStatus+="</p>",page.querySelector(".regStatus").innerHTML=regStatus,pluginSecurityInfo.IsMBSupporter?(page.querySelector(".premiumDescription").classList.add("hide"),page.querySelector(".supporterDescription").classList.add("hide"),0<pkg.price?(page.querySelector(".premiumHasPrice").classList.remove("hide"),page.querySelector(".featureId").value=pkg.featureId,page.querySelector(".featureName").value=pkg.name,page.querySelector(".amount").value=pkg.price,page.querySelector(".regPrice").innerHTML="<h3>"+_globalize.default.translate("ValuePriceUSD").replace("{0}",pkg.price.toFixed(2))+"</h3>",page.querySelector(".ppButton").classList.add("hide"),expDateTime="https://mb3admin.com/admin/service/user/getPayPalEmail?id="+pkg.owner,fetch(expDateTime).then(function(response){return response.json()}).then(function(dev){dev.payPalEmail&&(page.querySelector(".payPalEmail").value=dev.payPalEmail,page.querySelector(".ppButton").classList.remove("hide"))})):page.querySelector(".premiumHasPrice").classList.add("hide")):(pkg.price?(page.querySelector(".premiumDescription").classList.remove("hide"),page.querySelector(".supporterDescription").classList.add("hide")):(page.querySelector(".premiumDescription").classList.add("hide"),page.querySelector(".supporterDescription").classList.remove("hide")),page.querySelector(".ppButton").classList.add("hide"))):page.querySelector(".premiumPackage").classList.add("hide"))}(page,pkg,pluginSecurityInfo),pkg.richDescUrl?(page.querySelector(".pViewWebsite").classList.remove("hide"),page.querySelector(".pViewWebsite a").setAttribute("href",pkg.richDescUrl)):page.querySelector(".pViewWebsite").classList.add("hide"),pkg.previewImage||pkg.thumbImage?(owner=pkg.previewImage||pkg.thumbImage,page.querySelector(".pPreviewImage").classList.remove("hide"),page.querySelector(".pPreviewImage").innerHTML="<img class='pluginPreviewImg' src='"+owner+"' style='max-width: 100%;' />"):(page.querySelector(".pPreviewImage").classList.add("hide"),page.querySelector(".pPreviewImage").innerHTML=""),installedPlugins?(pluginSecurityInfo=_globalize.default.translate("LabelVersionInstalled").replace("{0}","<strong>"+installedPlugins.Version+"</strong>"),page.querySelector(".pCurrentVersion").classList.remove("hide"),page.querySelector(".pCurrentVersion").innerHTML=pluginSecurityInfo):(page.querySelector(".pCurrentVersion").classList.add("hide"),page.querySelector(".pCurrentVersion").innerHTML=""),_loading.default.hide()}function performInstallation(page,apiClient,packageName,guid,updateClass,version){function alertCallback(){_loading.default.show(),page.querySelector(".btnInstall").disabled=!0,apiClient.installPlugin(packageName,guid,updateClass,version).then(function(){var options;_loading.default.hide(),options=_globalize.default.translate("PluginInstalledMessage"),Emby.importModule("./modules/common/dialogs/alert.js").then(function(alert){return alert(options)})})}var options,developer=page.querySelector(".developer").innerHTML.toLowerCase();"luke"!==developer&&"ebr"!==developer&&"softworkz"!==developer&&"emby"!==developer?(_loading.default.hide(),developer=(developer=_globalize.default.translate("MessagePluginInstallDisclaimer")+"<br/><br/>")+_globalize.default.translate("PleaseConfirmPluginInstallation"),options=developer,_globalize.default.translate("HeaderConfirmPluginInstallation"),Emby.importModule("./modules/common/dialogs/confirm.js").then(function(confirm){return confirm(options)}).then(alertCallback)):alertCallback()}function View(view,params){_baseview.default.apply(this,arguments);var instance=this,revisionHistoryItemsContainer=(view.querySelector(".addPluginForm").addEventListener("submit",function(e){_loading.default.show();var page=this.closest(".page"),name=params.name,guid=params.guid,apiClient=instance.getApiClient();return apiClient.getInstalledPlugins().then(function(plugins){var vals=page.querySelector(".selectVersion").value.split("|"),version=vals[0];performInstallation(page,apiClient,name,guid,vals[1],version)}),e.preventDefault(),e.stopPropagation(),!1}),view.querySelector(".revisionHistory"));revisionHistoryItemsContainer.fetchData=function(query){var serverId=this.getApiClient().serverId(),_this$pkg=(null==(_this$pkg=this.pkg)?void 0:_this$pkg.versions)||[],totalRecordCount=_this$pkg.length;return null!=query&&query.StartIndex&&(_this$pkg=_this$pkg.slice(query.StartIndex)),null!=(null==query?void 0:query.Limit)&&(_this$pkg.length=Math.min(_this$pkg.length,query.Limit)),Promise.resolve({TotalRecordCount:totalRecordCount,Items:_this$pkg.map(function(version){return{Type:"GenericListItem",ServerId:serverId,Name:version.versionStr,ShortOverview:version.description,Icon:"published_with_changes",DateCreated:version.timestamp}})})}.bind(this),revisionHistoryItemsContainer.getListOptions=function(items){return{renderer:_listview.default,options:{fields:["Name","DateCreated","ShortOverview"],enableDefaultIcon:!0,action:"none",draggable:!1,multiSelect:!1,contextMenu:!1,mediaInfo:!1,largeHeading:!0,roundImage:!0},virtualScrollLayout:"vertical-list"}}.bind(this),this.revisionHistoryItemsContainer=revisionHistoryItemsContainer}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,require(["css!plugins/addpluginpage.css"]),Object.assign(View.prototype,_baseview.default.prototype),View.prototype.onResume=function(options){_baseview.default.prototype.onResume.apply(this,arguments);var page=this.view,params=(_loading.default.show(),this.params),name=params.name,params=params.guid,apiClient=this.getApiClient(),name=apiClient.getPackageInfo(name,params),params=apiClient.getInstalledPlugins(),instance=(_connectionmanager.default.getRegistrationInfo("themes",apiClient,{viewOnly:!0}),this);Promise.all([name,params]).then(function(responses){instance.pkg=responses[0],_connectionmanager.default.getRegistrationInfo("themes",apiClient,{viewOnly:!0}).then(function(){instance.revisionHistoryItemsContainer.resume(options),renderPackage(responses[0],responses[1],{IsMBSupporter:!0},page)},function(){renderPackage(responses[0],responses[1],{},page)})})},View.prototype.onPause=function(){_baseview.default.prototype.onPause.apply(this,arguments),this.revisionHistoryItemsContainer.pause()},View.prototype.destroy=function(){_baseview.default.prototype.destroy.apply(this,arguments),this.revisionHistoryItemsContainer=null,this.pkg=null};_exports.default=View});