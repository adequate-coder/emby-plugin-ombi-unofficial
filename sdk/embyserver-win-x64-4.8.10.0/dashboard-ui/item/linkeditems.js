define(["exports","./../modules/emby-elements/emby-scroller/emby-scroller.js","./../modules/layoutmanager.js","./../modules/cardbuilder/cardbuilder.js","./../modules/listview/listview.js","./../modules/common/globalize.js","./../modules/common/usersettings/usersettings.js","./../modules/emby-apiclient/connectionmanager.js"],function(_exports,_embyScroller,_layoutmanager,_cardbuilder,_listview,_globalize,_usersettings,_connectionmanager){function getCardOptions(options,scrollX){return{renderer:_cardbuilder.default,options:Object.assign({shape:"autooverflow",fields:["Name","ProductionYear"],centerText:!0,overlayPlayButton:!0,focusTransformTitleAdjust:!0},options),virtualScrollLayout:scrollX?"horizontal-grid":null}}function getGenericCardOptions(){var instance=this.instance,linkedItemType=this.linkedItemType,scrollX=this.scrollX,instance=instance.options.item,parentItemType=null==instance?void 0:instance.Type;switch(linkedItemType){case"MusicArtist":return getCardOptions({fields:["Name"],round:!0},scrollX);case"Playlist":return getCardOptions({fields:["Name"]},scrollX);case"MusicAlbum":case"MusicVideo":return getCardOptions({fields:"MusicArtist"===parentItemType?["Name","ProductionYear"]:["ParentName","Name"]},scrollX);case"Season":case"Episode":return getCardOptions({fields:["ParentName","Name"]},scrollX);case"Person":case"Folder":return getCardOptions({fields:["Name"]},scrollX);default:return getCardOptions({},scrollX)}}function enableWrappedListView(){return!_layoutmanager.default.tv}function addParentItemToQuery(instance,query){var instance=instance.options,params=instance.params,item=instance.item,instance=params.parentId;switch(instance&&(query.ParentId=instance),item.Type){case"Genre":case"MusicGenre":case"GameGenre":query.GenreIds=item.Id;break;case"Studio":query.StudioIds=item.Id;break;case"Person":query.PersonIds=item.Id;break;case"MusicArtist":query.ArtistIds=item.Id;break;case"Tag":query.TagIds=item.Id;break;case"BoxSet":case"Folder":query.ParentId=item.Id}}function fetchItems(query){var instance=this.instance,linkedItemType=this.linkedItemType,scrollX=this.scrollX,item=instance.options.item,itemType=item.Type;return"BoxSet"===itemType?function(query,instance,item,linkedItemType,scrollX){var apiClient,sortBy,sortOrder;return"BoxSet"!==item.Type?Promise.resolve({Items:[],TotalRecordCount:0}):(apiClient=_connectionmanager.default.getApiClient(item),"default"===(sortBy=_usersettings.default.itemSortBy(item.Id)||"default")&&(sortBy="DisplayOrder"),sortOrder=(sortBy=apiClient.isMinServerVersion("4.8.0.16")?sortBy:null)?_usersettings.default.itemSortOrder(item.Id):null,linkedItemType&&(query.IncludeItemTypes=linkedItemType),query=Object.assign({ParentId:item.Id,ImageTypeLimit:1,Fields:instance.getRequestedItemFields()+",PrimaryImageAspectRatio,ProductionYear,Status,EndDate",EnableTotalRecordCount:!!scrollX,sortBy:sortBy,sortOrder:sortOrder},query),console.log("query start index: "+query.StartIndex),apiClient.getItems(apiClient.getCurrentUserId(),query).then(function(result){for(var i=0,length=result.Items.length;i<length;i++)result.Items[i].CollectionId=item.Id;return result}))}(query,instance,item,linkedItemType,scrollX):"MusicArtist"===linkedItemType?function(query,instance,scrollX){var apiClient=instance.getApiClient();return query=Object.assign({SortBy:"SortName",SortOrder:"Ascending",Recursive:!0,Fields:instance.getRequestedItemFields()+",PrimaryImageAspectRatio",StartIndex:0,ImageTypeLimit:1,EnableTotalRecordCount:!!scrollX,EnableImageTypes:"Primary"},query),addParentItemToQuery(instance,query),apiClient.getArtists(apiClient.getCurrentUserId(),query)}(query,instance,scrollX):(item="SortName",scrollX="Ascending","MusicVideo"===linkedItemType&&"MusicArtist"===itemType&&(item="ProductionYear,SortName",scrollX="Descending"),itemType=instance.getApiClient(),query=Object.assign({SortBy:item,SortOrder:scrollX,Recursive:!0,Fields:instance.getRequestedItemFields()+",PrimaryImageAspectRatio,ProductionYear,Status,EndDate",ImageTypeLimit:1,EnableImageTypes:"Primary,Backdrop,Logo"},query),linkedItemType&&(query.IncludeItemTypes=linkedItemType),addParentItemToQuery(instance,query),itemType.getItems(itemType.getCurrentUserId(),query))}function getSongListOptions(items){return enableWrappedListView()?{renderer:_listview.default,options:Object.assign({action:"playallfromhere",overlayPlayButton:!1,verticalWrap:!0,mediaInfo:!1,enableSideMediaInfo:!1,enableUserDataButtons:!1,fields:["Name","ParentName"]},{}),virtualScrollLayout:"horizontal-grid"}:getCardOptions({action:"playallfromhere",fields:["Name","ParentName"],overlayPlayButton:!1,sideFooter:!0,centerText:!1},!0)}function getSectionHtml(scrollX,params,item,linkedItemType,title,href){var className="linked-"+linkedItemType+"-section",className=(scrollX?className+=" autoScrollSection":href=null,"BoxSet"===item.Type&&(href=null),'<div class="'+className+' hide verticalSection verticalSection-cards">'),itemsContainerClass="",titleContainerClass="",cardSizeAttribute=("Audio"===linkedItemType&&(itemsContainerClass+=" itemsContainer-sideFooters"),enableWrappedListView()?titleContainerClass+="Audio"===linkedItemType?" sectionTitleContainer-wrappedlistview":" sectionTitleContainer-cards":titleContainerClass+=" sectionTitleContainer-cards",_layoutmanager.default.tv||(titleContainerClass+=" focusable"),""),linkedItemType=(_layoutmanager.default.tv||"MusicArtist"===linkedItemType&&(cardSizeAttribute=' data-cardsizeoffset="1"'),linkedItemType?' data-itemtype="'+linkedItemType+'"':""),className=(className+='<div class="sectionTitleContainer padded-left padded-left-page padded-right'+titleContainerClass+'" data-focusabletype="nearest">')+function(params,item,href,title){if(title='<h2 class="sectionTitle sectionTitle-cards">'+title+"</h2>",href&&!_layoutmanager.default.tv){switch(item.Type){case"Genre":href+="&genreId="+params.id;break;case"MusicGenre":href+="&musicGenreId="+params.id;break;case"GameGenre":href+="&gameGenreId="+params.id;break;case"Studio":href+="&studioId="+params.id;break;case"Person":href+="&personId="+params.id;break;case"MusicArtist":href+="&artistId="+params.id;break;case"Tag":href+="&tagId="+params.id;break;case"BoxSet":case"Folder":href+="&parentId="+params.id}item=params.parentId;item&&(href+="&parentId="+item),title='<a href="'+(href+="&serverId="+params.serverId)+'" is="emby-sectiontitle" class="noautofocus button-link button-link-color-inherit sectionTitleTextButton sectionTitleTextButton-link sectionTitleTextButton-more">'+title+"</a>"}return title}(params,item,href,title)+"</div>";return className=scrollX?className+'<div is="emby-scroller" data-mousewheel="false" data-focusscroll="true" class="padded-top-focusscale padded-bottom-focusscale padded-left padded-left-page padded-right"><div'+linkedItemType+' is="emby-itemscontainer" data-focusabletype="nearest"'+cardSizeAttribute+' class="itemsContainer scrollSlider focusable focuscontainer-x'+itemsContainerClass+'" data-virtualscrolllayout="horizontal-grid"></div></div>':className+"<div"+linkedItemType+' is="emby-itemscontainer" class="itemsContainer focuscontainer-x padded-left padded-left-page padded-right'+itemsContainerClass+'"></div>',className+="</div>"}function LinkedItemsView(options){this.options=options}function setSectionTitle(view,selector,title){view=view.querySelector(selector);view&&(view.innerHTML=title)}function loadItemTypes(instance,parent){var itemType=parent.Type,itemTypes=[];switch(itemType){case"Person":case"Tag":case"Genre":itemTypes.push("Movie")}switch(itemType){case"Person":case"Tag":case"Genre":itemTypes.push("Series")}switch(itemType){case"Person":case"Tag":case"Genre":itemTypes.push("Episode")}switch(itemType){case"MusicGenre":case"Tag":itemTypes.push("MusicArtist"),itemTypes.push("MusicAlbum")}switch(itemType){case"Genre":case"MusicGenre":case"Tag":itemTypes.push("Playlist")}switch(itemType){case"Studio":case"MusicGenre":case"Tag":itemTypes.push("Audio")}switch(itemType){case"Person":case"MusicArtist":case"Tag":case"MusicGenre":itemTypes.push("MusicVideo")}switch(itemType){case"Person":case"Tag":case"Genre":itemTypes.push("Trailer")}switch(itemType){case"Person":case"Tag":case"Genre":itemTypes.push("Video")}return"BoxSet"!==itemType?(instance.options.itemTypes=itemTypes,Promise.resolve()):function(instance,parent){var parent=_connectionmanager.default.getApiClient(parent),query={};return addParentItemToQuery(instance,query),parent.getItemTypes(parent.getCurrentUserId(),query).then(function(result){return result.Items.map(function(i){return i.Name})})}(instance,parent).then(function(types){types.length||(types=["Items"]),"BoxSet"===itemType&&!_usersettings.default.groupCollectionItems()&&1<types.length&&(types=["Items"]),instance.options.itemTypes=types})}function loadSections(instance,resumeOptions){if(instance.sectionsLoaded&&!resumeOptions.refresh)return Promise.resolve();instance.sectionsLoaded=!0;resumeOptions=instance.options.item;return loadItemTypes(instance,resumeOptions).then(function(){options=instance.options,html="",item=options.item,params=options.params,itemTypes=options.itemTypes,scrollX=!0,"BoxSet"===item.Type&&itemTypes.length<2&&(scrollX=!1),itemTypes.includes("MovieSeries")&&(html+=getSectionHtml(scrollX,params,item,"Movie,Series",_globalize.default.translate("MoviesAndShows"),"list/list.html?type=Movie,Series")),itemTypes.includes("Movie")&&(html+=getSectionHtml(scrollX,params,item,"Movie",_globalize.default.translate("Movies"),"list/list.html?type=Movie")),itemTypes.includes("Series")&&(html+=getSectionHtml(scrollX,params,item,"Series",_globalize.default.translate("Shows"),"list/list.html?type=Series")),itemTypes.includes("Season")&&(html+=getSectionHtml(scrollX,params,item,"Season",_globalize.default.translate("Seasons"),"list/list.html?type=Season")),itemTypes.includes("Episode")&&(html+=getSectionHtml(scrollX,params,item,"Episode",_globalize.default.translate("Episodes"),"list/list.html?type=Episode")),itemTypes.includes("MusicArtist")&&(html+=getSectionHtml(scrollX,params,item,"MusicArtist",_globalize.default.translate("Artists"),"list/list.html?type=MusicArtist")),itemTypes.includes("MusicAlbum")&&(html+=getSectionHtml(scrollX,params,item,"MusicAlbum",_globalize.default.translate("Albums"),"list/list.html?type=MusicAlbum")),itemTypes.includes("Playlist")&&(html+=getSectionHtml(scrollX,params,item,"Playlist",_globalize.default.translate("Playlists"),"list/list.html?type=Playlist")),itemTypes.includes("Audio")&&(html+=getSectionHtml(scrollX,params,item,"Audio",_globalize.default.translate("Songs"),"list/list.html?type=Audio")),itemTypes.includes("MusicVideo")&&(html+=getSectionHtml(scrollX,params,item,"MusicVideo",_globalize.default.translate("HeaderMusicVideos"),"list/list.html?type=MusicVideo")),itemTypes.includes("Trailer")&&(html+=getSectionHtml(scrollX,params,item,"Trailer",_globalize.default.translate("Trailers"),"list/list.html?type=Trailer")),itemTypes.includes("Video")&&(html+=getSectionHtml(scrollX,params,item,"Video",_globalize.default.translate("Videos"),"list/list.html?type=Video")),itemTypes.includes("Game")&&(html+=getSectionHtml(scrollX,params,item,"Game",_globalize.default.translate("Games"),"list/list.html?type=Game")),itemTypes.includes("Book")&&(html+=getSectionHtml(scrollX,params,item,"Book",_globalize.default.translate("Books"),"list/list.html?type=Book")),itemTypes.includes("Folder")&&(html+=getSectionHtml(scrollX,params,item,"Folder",_globalize.default.translate("Folders"))),itemTypes.includes("Person")&&(html+=getSectionHtml(scrollX,params,item,"Person",_globalize.default.translate("People"))),itemTypes.includes("Items")&&(html+=getSectionHtml(scrollX,params,item,null,_globalize.default.translate("Items"))),options.view.innerHTML=html,function(instance){var options=instance.options,view=options.view,params=options.params,itemsContainers=Array.prototype.slice.call(view.querySelectorAll(".itemsContainer"),0);if(params.parentId)for(var i=0,length=itemsContainers.length;i<length;i++)itemsContainers[i].setAttribute("data-parentid",params.parentId);for(var _i=0,_length=itemsContainers.length;_i<_length;_i++){var itemsContainer=itemsContainers[_i],linkedItemType=(itemsContainer.parentContainer=itemsContainer.closest(".verticalSection"),itemsContainer.getAttribute("data-itemtype")),scrollX=itemsContainer.classList.contains("scrollSlider");itemsContainer.fetchData=fetchItems.bind({instance:instance,linkedItemType:linkedItemType,scrollX:scrollX}),itemsContainer.getListOptions="Audio"===linkedItemType?getSongListOptions.bind(instance):getGenericCardOptions.bind({instance:instance,linkedItemType:linkedItemType,scrollX:scrollX})}instance.itemsContainers=itemsContainers,params.parentId?options.apiClient.getItem(options.apiClient.getCurrentUserId(),params.parentId).then(function(parentItem){"audiobooks"===parentItem.CollectionType&&(setSectionTitle(view,".linked-MusicArtist-section .sectionTitle",_globalize.default.translate("Authors")),setSectionTitle(view,".linked-MusicAlbum-section .sectionTitle",_globalize.default.translate("Books")),setSectionTitle(view,".linked-Audio-section .sectionTitle",_globalize.default.translate("Episodes"))),view.classList.remove("hide")}):view.classList.remove("hide")}(instance);for(var options,html,item,params,itemTypes,scrollX,itemsContainers=instance.itemsContainers,promises=[],i=0,length=itemsContainers.length;i<length;i++)promises.push(itemsContainers[i].waitForCustomElementUpgrade());return Promise.all(promises)})}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,LinkedItemsView.prototype.resume=function(options){var instance=this;return this.options.item=options.item,loadSections(instance,options).then(function(){for(var promises=[],itemsContainers=instance.itemsContainers,i=0,length=itemsContainers.length;i<length;i++)promises.push(itemsContainers[i].resume(options));return Promise.all(promises).then(function(){options.autoFocus&&instance.autoFocus()})})},LinkedItemsView.prototype.getRequestedItemFields=function(){return this.options.requestedItemFields},LinkedItemsView.prototype.getApiClient=function(){return this.options.apiClient},LinkedItemsView.prototype.pause=function(){for(var itemsContainers=this.itemsContainers,i=0,length=itemsContainers.length;i<length;i++)itemsContainers[i].pause()},LinkedItemsView.prototype.destroy=function(){this.itemsContainers=null,this.options=null};_exports.default=LinkedItemsView});